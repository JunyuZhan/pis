name: pis

# ============================================
# âš ï¸ è­¦å‘Šï¼šæ­¤é…ç½®ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨å¯†é’¥ï¼Œä»…ç”¨äºå¼€å‘/æµ‹è¯•ï¼
#
# ğŸ” ç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨å®‰å…¨é…ç½®ï¼š
#   docker-compose.secrets.yml
#
# åŸå› ï¼š
#   - æ­¤é…ç½®å¯†é’¥é€šè¿‡ç¯å¢ƒå˜é‡æš´éœ²
#   - docker inspect å¯ç›´æ¥æŸ¥çœ‹æ‰€æœ‰å¯†é’¥
#   - å¯†é’¥å¯èƒ½å‡ºç°åœ¨æ—¥å¿—å’Œè¿›ç¨‹åˆ—è¡¨ä¸­
#
# å®‰å…¨éƒ¨ç½²æ–¹æ³•ï¼š
#   1. cd docker/secrets && ./init-secrets.sh
#   2. docker compose -f docker-compose.secrets.yml up -d
#
# è¯¦è§ï¼šdocker/DEPLOY-SECURE.md
# ============================================
#
# åŒ…å«æœåŠ¡ï¼š
# - PostgreSQL: æ•°æ®åº“ï¼ˆç«¯å£ 5432ï¼Œä»…å†…éƒ¨ï¼‰
# - MinIO: å¯¹è±¡å­˜å‚¨ï¼ˆç«¯å£ 9000/9001ï¼Œä»…å†…éƒ¨ï¼‰
# - Redis: ä»»åŠ¡é˜Ÿåˆ—/ç¼“å­˜ï¼ˆç«¯å£ 6379ï¼Œä»…å†…éƒ¨ï¼‰
# - Web: Next.js å‰ç«¯ï¼ˆç«¯å£ 3000ï¼Œä»…å†…éƒ¨ï¼‰
# - Worker: å›¾ç‰‡å¤„ç†æœåŠ¡ï¼ˆç«¯å£ 3001ï¼Œä»…å†…éƒ¨ï¼‰
# - Nginx: åå‘ä»£ç†ï¼ˆç«¯å£ 8088ï¼Œå”¯ä¸€å¯¹å¤–ç«¯å£ï¼‰
#
# ç«¯å£è¯´æ˜ï¼ˆå•ç«¯å£æ¨¡å¼ï¼‰ï¼š
# - 8088: Nginx (å”¯ä¸€å¯¹å¤–ç«¯å£ï¼Œæ‰€æœ‰ Web è®¿é—®é€šè¿‡æ­¤ç«¯å£)
# - 21: Worker FTP (FTP å‘½ä»¤ç«¯å£)
# - 30000-30009: Worker FTP (FTP è¢«åŠ¨æ¨¡å¼ç«¯å£èŒƒå›´)
#
# å…¶ä»–æœåŠ¡ç«¯å£ä¸å¯¹å¤–æš´éœ²ï¼Œä»…é€šè¿‡ Docker å†…éƒ¨ç½‘ç»œè®¿é—®
# ============================================

networks:
  pis-network:
    driver: bridge
    name: pis-network

volumes:
  pis_postgres_data:
    name: pis_postgres_data
  pis_minio_data:
    name: pis_minio_data
  pis_redis_data:
    name: pis_redis_data
  pis_worker_logs:
    name: pis_worker_logs
  pis_web_logs:
    name: pis_web_logs
  # pis_ai_models:  # AI æœåŠ¡å·²ç¦ç”¨ï¼Œvolume ä¸å†éœ€è¦
  #   name: pis_ai_models

services:
  # ==================== æ•°æ®åº“ ====================
  postgres:
    image: pgvector/pgvector:pg16
    pull_policy: if_not_present  # ä¼˜å…ˆä½¿ç”¨æœ¬åœ°é•œåƒï¼Œä¸å­˜åœ¨æ—¶æ‰æ‹‰å–
    container_name: pis-postgres
    env_file:
      - ../.env
    environment:
      # PostgreSQL é»˜è®¤é…ç½®ï¼ˆå¯è¢« .env è¦†ç›–ï¼‰
      POSTGRES_DB: ${POSTGRES_DB:-pis}
      POSTGRES_USER: ${POSTGRES_USER:-pis}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-changeme}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - pis_postgres_data:/var/lib/postgresql/data
      # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ï¼ˆPostgreSQL å®¹å™¨ä¼šåœ¨é¦–æ¬¡å¯åŠ¨æ—¶æŒ‰æ–‡ä»¶åæ’åºæ‰§è¡Œï¼‰
      # æ‰§è¡Œé¡ºåºï¼šinit-postgresql-db.sql -> init-postgresql.sh
      - ./init-postgresql-db.sql:/docker-entrypoint-initdb.d/init-postgresql-db.sql:ro
      - ./init-postgresql.sh:/docker-entrypoint-initdb.d/init-postgresql.sh:ro
    # ports:
    #   - "5432:5432"  # PostgreSQL æ•°æ®åº“ç«¯å£ (ä»…å†…éƒ¨è®¿é—®)
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-pis} -d ${POSTGRES_DB:-pis}",
        ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================== å¯¹è±¡å­˜å‚¨ ====================
  minio:
    image: minio/minio:RELEASE.2025-04-22T22-12-26Z
    pull_policy: if_not_present  # ä¼˜å…ˆä½¿ç”¨æœ¬åœ°é•œåƒï¼Œä¸å­˜åœ¨æ—¶æ‰æ‹‰å–
    container_name: pis-minio
    env_file:
      - ../.env
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-minioadmin}
      # MinIO Console è®¿é—®è·¯å¾„
      MINIO_BROWSER_REDIRECT_URL: ${NEXT_PUBLIC_APP_URL:-http://${DOMAIN:-localhost}:8088}/minio-console
    volumes:
      - pis_minio_data:/data
    command: server /data --console-address ":9001"
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # MinIO Bucket åˆå§‹åŒ–
  # æ³¨æ„ï¼šWorker å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ£€æŸ¥å¹¶åˆ›å»º bucketï¼Œæ­¤å®¹å™¨ä½œä¸ºå¤‡ç”¨åˆå§‹åŒ–
  minio-init:
    image: minio/mc:latest
    pull_policy: if_not_present  # ä¼˜å…ˆä½¿ç”¨æœ¬åœ°é•œåƒï¼Œä¸å­˜åœ¨æ—¶æ‰æ‹‰å–
    container_name: pis-minio-init
    env_file:
      - ../.env
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - pis-network
    environment:
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      mc alias set pis http://pis-minio:9000 $${MINIO_ACCESS_KEY} $${MINIO_SECRET_KEY};
      mc mb pis/pis-photos --ignore-existing || true;
      # è®¾ç½®æ•´ä¸ª bucket ä¸ºå…¬å¼€ä¸‹è½½
      # ä¸Šä¼ éœ€è¦é¢„ç­¾å URLï¼ˆæœ‰ç­¾åéªŒè¯ï¼‰ï¼Œä¸‹è½½å¯ä»¥ç›´æ¥è®¿é—®
      mc anonymous set download pis/pis-photos || true;
      echo 'MinIO bucket initialized with public download access';
      exit 0;
      "
    restart: "no" # åªè¿è¡Œä¸€æ¬¡ï¼ŒWorker ä¼šè´Ÿè´£ç¡®ä¿ bucket å­˜åœ¨

  # ==================== ä»»åŠ¡é˜Ÿåˆ— ====================
  redis:
    image: redis:7-alpine
    pull_policy: if_not_present  # ä¼˜å…ˆä½¿ç”¨æœ¬åœ°é•œåƒï¼Œä¸å­˜åœ¨æ—¶æ‰æ‹‰å–
    container_name: pis-redis
    volumes:
      - pis_redis_data:/data
    command: redis-server --appendonly yes
    # ports:
    #   - "6379:6379"  # Redis ç«¯å£ (ä»…å†…éƒ¨è®¿é—®)
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================== å›¾ç‰‡å¤„ç† Worker ====================
  worker:
    build:
      context: ..
      dockerfile: docker/worker.Dockerfile
    container_name: pis-worker
    env_file:
      - ../.env
    environment:
      # æ•°æ®åº“è¿æ¥æ¨¡å¼ï¼ˆstandalone æ¨¡å¼ä½¿ç”¨ PostgreSQLï¼‰
      - DATABASE_TYPE=${DATABASE_TYPE:-postgresql}
      # PostgreSQL ç›´è¿é…ç½®
      # æ³¨æ„ï¼šDATABASE_PASSWORD å’Œ POSTGRES_PASSWORD ä» env_file (../.env) è¯»å–
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=${POSTGRES_DB:-pis}
      - DATABASE_USER=${POSTGRES_USER:-pis}
      # DATABASE_PASSWORD ä» env_file è¯»å–ï¼Œä¸éœ€è¦åœ¨è¿™é‡Œè®¾ç½®
      # MinIO
      - MINIO_ENDPOINT_HOST=pis-minio
      - MINIO_ENDPOINT_PORT=9000
      - MINIO_USE_SSL=false
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - MINIO_BUCKET=${MINIO_BUCKET:-pis-photos}
      # Storage é…ç½®
      - STORAGE_TYPE=minio
      - STORAGE_ENDPOINT=pis-minio
      - STORAGE_PORT=9000
      - STORAGE_USE_SSL=false
      - STORAGE_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - STORAGE_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - STORAGE_BUCKET=${MINIO_BUCKET:-pis-photos}
      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Worker é…ç½®
      - NODE_ENV=production
      - HTTP_PORT=3001
      - WORKER_API_KEY=${WORKER_API_KEY:-changeme}
      # å­˜å‚¨å…¬ç½‘ URL
      - STORAGE_PUBLIC_URL=${STORAGE_PUBLIC_URL:-http://${DOMAIN:-localhost}:9000}
      - MINIO_PUBLIC_URL=${MINIO_PUBLIC_URL:-http://${DOMAIN:-localhost}:8088/media}
      # å‘Šè­¦é…ç½®
      - ALERT_ENABLED=${ALERT_ENABLED:-true}
      - ALERT_TYPE=${ALERT_TYPE:-log}
      # FTP é…ç½®
      - FTP_USER=${FTP_USER:-pis}
      - FTP_PASSWORD=${FTP_PASSWORD:-pis}
      - FTP_PORT=21
      - FTP_PASV_START=30000
      - FTP_PASV_END=30009
      - FTP_PASV_URL=${FTP_PASV_URL:-} # ç•™ç©ºåˆ™è‡ªåŠ¨æ£€æµ‹
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "21:21"             # FTP å‘½ä»¤ç«¯å£
      - "30000-30009:30000-30009" # FTP è¢«åŠ¨æ¨¡å¼ç«¯å£èŒƒå›´
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      test: ["CMD", "node", "-e", "console.log('healthy')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==================== Next.js å‰ç«¯ ====================
  web:
    build:
      context: ..
      dockerfile: docker/web.Dockerfile
      args:
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-https://${DOMAIN:-localhost}}
        NEXT_PUBLIC_MEDIA_URL: ${NEXT_PUBLIC_MEDIA_URL:-https://${DOMAIN:-localhost}/media}
        NEXT_PUBLIC_PHOTOGRAPHER_NAME: ${NEXT_PUBLIC_PHOTOGRAPHER_NAME:-PIS Photography}
        NEXT_PUBLIC_PHOTOGRAPHER_TAGLINE: ${NEXT_PUBLIC_PHOTOGRAPHER_TAGLINE:-ä¸“ä¸šæ´»åŠ¨æ‘„å½±}
        # è½®è¯¢é…ç½®ï¼ˆstandalone æ¨¡å¼ä½¿ç”¨è½®è¯¢å®ç°å®æ—¶æ›´æ–°ï¼‰
        NEXT_PUBLIC_POLLING_INTERVAL: ${NEXT_PUBLIC_POLLING_INTERVAL:-3000}
        NEXT_PUBLIC_ADMIN_POLLING_INTERVAL: ${NEXT_PUBLIC_ADMIN_POLLING_INTERVAL:-2000}
    container_name: pis-web
    env_file:
      - ../.env
    environment:
      # è®¤è¯æ¨¡å¼ï¼ˆstandalone æ¨¡å¼ä½¿ç”¨è‡ªå®šä¹‰è®¤è¯ï¼‰
      - AUTH_MODE=${AUTH_MODE:-custom}
      - AUTH_JWT_SECRET=${AUTH_JWT_SECRET}
      # æ•°æ®åº“è¿æ¥ï¼ˆstandalone æ¨¡å¼ä½¿ç”¨ PostgreSQLï¼‰
      # æ³¨æ„ï¼šDATABASE_PASSWORD å’Œ POSTGRES_PASSWORD ä» env_file (../.env) è¯»å–
      - DATABASE_TYPE=${DATABASE_TYPE:-postgresql}
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=${POSTGRES_DB:-pis}
      - DATABASE_USER=${POSTGRES_USER:-pis}
      # DATABASE_PASSWORD ä» env_file è¯»å–ï¼Œä¸éœ€è¦åœ¨è¿™é‡Œè®¾ç½®
      # åº”ç”¨é…ç½®
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-http://${DOMAIN:-localhost}:8088}
      - NEXT_PUBLIC_MEDIA_URL=${NEXT_PUBLIC_MEDIA_URL:-http://${DOMAIN:-localhost}:8088/media}
      - NEXT_PUBLIC_PHOTOGRAPHER_NAME=${NEXT_PUBLIC_PHOTOGRAPHER_NAME:-PIS Photography}
      - NEXT_PUBLIC_PHOTOGRAPHER_TAGLINE=${NEXT_PUBLIC_PHOTOGRAPHER_TAGLINE:-ä¸“ä¸šæ´»åŠ¨æ‘„å½±}
      # Worker API
      - WORKER_URL=http://pis-worker:3001
      - NEXT_PUBLIC_WORKER_URL=${NEXT_PUBLIC_WORKER_URL:-http://${DOMAIN:-localhost}:8088/worker-api}
      - WORKER_API_KEY=${WORKER_API_KEY:-changeme}
      # MinIO é…ç½®ï¼ˆç”¨äºåª’ä½“æ–‡ä»¶å’Œ MinIO Console ä»£ç†ï¼‰
      - MINIO_ENDPOINT_HOST=pis-minio
      - MINIO_ENDPOINT_PORT=9000
      - MINIO_CONSOLE_PORT=9001
      - MINIO_USE_SSL=false
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - MINIO_BUCKET=${MINIO_BUCKET:-pis-photos}
      # ä¼šè¯å¯†é’¥ï¼ˆå¿…é¡»è®¾ç½®ï¼‰
      - ALBUM_SESSION_SECRET=${ALBUM_SESSION_SECRET}
      # è½®è¯¢é…ç½®ï¼ˆstandalone æ¨¡å¼ä½¿ç”¨è½®è¯¢å®ç°å®æ—¶æ›´æ–°ï¼‰
      - NEXT_PUBLIC_POLLING_INTERVAL=${NEXT_PUBLIC_POLLING_INTERVAL:-3000}
      - NEXT_PUBLIC_ADMIN_POLLING_INTERVAL=${NEXT_PUBLIC_ADMIN_POLLING_INTERVAL:-2000}
      # æ—¥å¿—é…ç½®
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - ENABLE_PRETTY_LOG=${ENABLE_PRETTY_LOG:-false}
      # Git ä»“åº“è·¯å¾„ï¼ˆç”¨äºå‡çº§æ£€æŸ¥åŠŸèƒ½ï¼‰
      # æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡ PROJECT_ROOT_MOUNT_PATH è‡ªå®šä¹‰å®¹å™¨å†…æŒ‚è½½è·¯å¾„
      - PROJECT_ROOT=${PROJECT_ROOT_MOUNT_PATH:-/opt/pis}
    volumes:
      - pis_web_logs:/app/logs
      # æŒ‚è½½é¡¹ç›®æ ¹ç›®å½•ï¼ˆåªè¯»ï¼‰ï¼Œç”¨äºå‡çº§æ£€æŸ¥åŠŸèƒ½è®¿é—® Git ä»“åº“
      # å®¹å™¨å†…è·¯å¾„æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡ PROJECT_ROOT_MOUNT_PATH è‡ªå®šä¹‰ï¼ˆé»˜è®¤ /opt/pisï¼‰
      - ../:${PROJECT_ROOT_MOUNT_PATH:-/opt/pis}:ro
    # ports:
    #   - "8081:3000" # Web å‰ç«¯ç«¯å£ (ç”± Nginx ä»£ç†)
    depends_on:
      postgres:
        condition: service_healthy
      worker:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      # ä½¿ç”¨ curlï¼ˆAlpine é•œåƒé»˜è®¤åŒ…å«ï¼Œæ— éœ€å®‰è£…ï¼‰
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ==================== AI æœåŠ¡ ====================
  # AI æœåŠ¡å·²ç¦ç”¨ï¼ˆç”¨äºèŠ‚çœèµ„æºï¼‰
  # å¦‚éœ€å¯ç”¨äººè„¸æœç´¢åŠŸèƒ½ï¼Œè¯·å–æ¶ˆä¸‹é¢çš„æ³¨é‡Š
  # ai:
  #   build:
  #     context: ../services/ai
  #     dockerfile: Dockerfile
  #   container_name: pis-ai
  #   ports:
  #     - "8000:8000"
  #   volumes:
  #     - pis_ai_models:/root/.insightface/models
  #   networks:
  #     - pis-network
  #   restart: unless-stopped

  # ==================== Nginx ====================
  nginx:
    image: nginx:alpine
    pull_policy: if_not_present  # ä¼˜å…ˆä½¿ç”¨æœ¬åœ°é•œåƒï¼Œä¸å­˜åœ¨æ—¶æ‰æ‹‰å–
    container_name: pis-nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    ports:
      - "8088:80"
    depends_on:
      web:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - pis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/nginx-health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
