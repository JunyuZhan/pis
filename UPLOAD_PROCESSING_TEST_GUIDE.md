# 上传业务逻辑和处理正确性测试指南

## 测试范围

### 1. 上传流程测试

#### 1.1 获取上传凭证
- ✅ 验证管理员权限
- ✅ 验证相册存在
- ✅ 验证文件类型和大小
- ✅ 创建照片记录（状态为 pending）
- ✅ 生成 presigned URL

#### 1.2 文件上传
- ✅ 上传到 MinIO 存储
- ✅ 验证上传成功

#### 1.3 触发处理
- ✅ 调用处理 API
- ✅ 添加到处理队列

### 2. 处理流程测试

#### 2.1 状态转换
- ✅ pending → processing → completed
- ✅ 错误处理：pending → failed

#### 2.2 处理步骤
- ✅ 下载原图
- ✅ 应用旋转
- ✅ 应用 AI 修图（如果启用）
- ✅ 应用风格预设
- ✅ 添加水印
- ✅ 生成缩略图
- ✅ 生成预览图
- ✅ 生成 BlurHash
- ✅ 上传处理后的文件

#### 2.3 结果验证
- ✅ 缩略图已生成
- ✅ 预览图已生成
- ✅ 数据库记录更新

### 3. 性能测试

#### 3.1 单文件上传性能
- 上传耗时
- 处理耗时
- 总耗时

#### 3.2 并发上传性能
- 并发处理能力
- 平均处理时间
- 内存使用情况

### 4. 错误处理测试

#### 4.1 上传错误
- 文件类型不支持
- 文件大小超限
- 网络错误
- 存储错误

#### 4.2 处理错误
- Worker 不可用
- 处理超时
- 处理失败

## 运行测试

### 基本测试

```bash
# 使用默认配置
./scripts/test/test-upload-and-processing.sh
```

### 自定义配置

```bash
# 设置基础 URL
export BASE_URL=http://localhost:3000

# 设置管理员账号
export ADMIN_EMAIL=admin@pis.com
export ADMIN_PASSWORD=admin123

# 设置测试图片大小（字节）
export TEST_IMAGE_SIZE=1024000  # 1MB

# 设置并发数
export CONCURRENT_UPLOADS=5

# 运行测试
./scripts/test/test-upload-and-processing.sh
```

## 测试检查点

### ✅ 功能正确性

1. **上传流程完整性**
   - [x] 获取上传凭证成功
   - [x] 文件上传成功
   - [x] 触发处理成功
   - [x] 照片记录创建成功

2. **处理流程正确性**
   - [x] 状态转换正确
   - [x] 处理步骤完整
   - [x] 结果文件生成

3. **错误处理**
   - [x] 权限验证
   - [x] 文件类型验证
   - [x] 文件大小验证
   - [x] 错误恢复机制

### ⚠️ 性能指标

1. **上传性能**
   - 单文件上传: < 2秒（1MB 文件）
   - 并发上传: < 5秒（5张并发）

2. **处理性能**
   - 处理触发: < 500ms
   - 处理完成: < 30秒（1MB 文件）

3. **资源使用**
   - 内存峰值: < 500MB（5张并发）
   - CPU 使用: < 80%

## 已知问题

### 1. Worker 不可用时的处理

**问题**: 如果 Worker 服务不可用，处理会失败

**解决方案**: 
- 处理 API 返回 202 状态码
- 后台异步重试机制
- 定期检查 pending 状态的照片

### 2. 大文件处理性能

**问题**: 大文件（>10MB）处理时间较长

**解决方案**:
- AI 修图自动跳过 >10MB 的文件
- 使用分片上传（>5MB）
- 异步处理队列

### 3. 并发处理限制

**问题**: 高并发时可能出现内存峰值

**解决方案**:
- BullMQ 并发限制（默认 5）
- 图片大小限制（100MB）
- 内存监控和告警

## 性能优化建议

### 1. 上传优化

- ✅ 使用分片上传（>5MB）
- ✅ 并发上传控制
- ✅ 断点续传支持

### 2. 处理优化

- ✅ AI 修图流式处理（已优化）
- ✅ 并行生成缩略图和预览图
- ✅ 缓存相册配置

### 3. 存储优化

- ✅ CDN 加速
- ✅ 图片压缩
- ✅ 懒加载

## 监控指标

### 关键指标

1. **上传成功率**: > 99%
2. **处理成功率**: > 95%
3. **平均处理时间**: < 30秒
4. **并发处理能力**: > 5张/秒

### 告警阈值

1. **上传失败率**: > 5%
2. **处理失败率**: > 10%
3. **平均处理时间**: > 60秒
4. **内存使用**: > 80%

## 测试报告模板

```
测试时间: 2026-02-06
测试环境: 本地开发环境
测试结果: ✅ 通过

功能测试:
- 上传流程: ✅ 通过
- 处理流程: ✅ 通过
- 错误处理: ✅ 通过

性能测试:
- 单文件上传: 1.2秒
- 处理完成: 25秒
- 并发上传 (5张): 3.5秒

问题:
- 无

建议:
- 无
```
