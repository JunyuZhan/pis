# 并发上传测试完整说明

## 测试流程

### 步骤 6: 并发上传测试（必须100%成功）

#### 6.1 并发上传执行
- **并发数**: 默认 5 张（可通过 `CONCURRENT_UPLOADS` 环境变量配置）
- **测试内容**:
  1. 获取上传凭证（并发）
  2. 上传文件到 MinIO（并发）
  3. 触发处理（并发）

#### 6.2 等待处理完成
- **等待时间**: 最多 180 秒
- **检查间隔**: 每 3 秒检查一次
- **验证**: 所有照片状态必须为 "completed"

#### 6.3 验证处理结果
- **验证内容**:
  - 缩略图已生成（thumb_key 不为空）
  - 预览图已生成（preview_key 不为空）
- **要求**: 必须100%完整

## 测试覆盖

### ✅ 已实现的测试

1. **并发上传流程** ✅
   - 获取上传凭证（并发）
   - 文件上传（并发）
   - 触发处理（并发）

2. **并发处理验证** ✅
   - 等待所有照片处理完成
   - 验证处理状态
   - 验证处理结果完整性

3. **错误处理** ✅
   - 上传失败检测
   - 处理失败检测
   - 结果不完整检测

4. **性能指标** ✅
   - 总耗时统计
   - 平均耗时计算
   - 成功率验证（必须100%）

## 测试要求

### ⚠️ 必须100%成功

- **并发上传**: 必须 100% 成功 (N/N)
- **并发处理**: 必须 100% 完成 (N/N)
- **处理结果**: 必须 100% 完整 (N/N)

任何失败都会导致测试退出（exit code 1）。

## 运行测试

```bash
# 默认并发数（5张）
./scripts/test/test-upload-and-processing.sh

# 自定义并发数
export CONCURRENT_UPLOADS=10
./scripts/test/test-upload-and-processing.sh
```

## 测试输出示例

```
步骤 6: 性能测试 - 并发上传（必须100%成功）
  并发数: 5
✓ 并发上传完成 (总耗时: 3500ms, 平均: 700ms/张, 成功率: 100%)

步骤 6.1: 等待并发上传的照片处理完成（必须100%完成）
  等待并发处理中... (3/180秒) - 完成: 2/5
  等待并发处理中... (6/180秒) - 完成: 5/5
✓ 所有并发上传的照片处理完成 (5/5, 100%)

步骤 6.2: 验证并发上传的处理结果（必须100%完整）
✓ Photo abc-123 处理结果完整
✓ Photo def-456 处理结果完整
✓ Photo ghi-789 处理结果完整
✓ Photo jkl-012 处理结果完整
✓ Photo mno-345 处理结果完整
✓ 所有并发上传的照片处理结果完整 (5/5, 100%)
```

## 验证点

### 1. 并发上传验证
- ✅ 所有并发任务成功
- ✅ 成功率 = 100%
- ✅ 所有照片 ID 已记录

### 2. 并发处理验证
- ✅ 所有照片状态 = "completed"
- ✅ 无失败照片
- ✅ 处理完成率 = 100%

### 3. 处理结果验证
- ✅ 所有照片都有缩略图
- ✅ 所有照片都有预览图
- ✅ 结果完整率 = 100%

## 性能指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 并发上传成功率 | 100% | 必须100% |
| 并发处理完成率 | 100% | 必须100% |
| 处理结果完整率 | 100% | 必须100% |
| 平均上传时间 | < 2秒/张 | 性能指标 |
| 平均处理时间 | < 30秒/张 | 性能指标 |

## 注意事项

1. **并发数限制**
   - 默认 5 张并发
   - 可根据服务器资源调整
   - 建议不超过 10 张

2. **等待时间**
   - 最多等待 180 秒
   - 如果处理时间较长，可能需要调整

3. **资源要求**
   - 足够的服务器资源
   - Worker 服务必须运行
   - 数据库和存储必须可用

## 总结

✅ **并发上传测试已完整实现**，包括：
- 并发上传执行
- 并发处理验证
- 处理结果验证
- 100%成功率要求

所有测试步骤都要求100%成功，任何失败都会导致测试退出。
