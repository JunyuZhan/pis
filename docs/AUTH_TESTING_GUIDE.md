# 🧪 PIS 认证系统测试指南

**测试时间**: 2026-02-06  
**测试目的**: 验证登录/登出逻辑，检查是否有意外登出的问题

---

## 🎯 测试场景

### 1. 正常登录/登出流程 ✅

**测试步骤**:
1. 访问 `/admin/login`
2. 输入正确的邮箱和密码
3. 点击登录
4. 检查是否成功跳转到 `/admin`
5. 点击登出按钮
6. 检查是否成功跳转到 `/admin/login`

**预期结果**:
- ✅ 登录成功，跳转到 `/admin`
- ✅ 登出成功，跳转到 `/admin/login`
- ✅ Cookie 被正确清除

---

### 2. 网络错误场景 ⚠️ **关键测试**

**测试步骤**:
1. 登录系统
2. 打开浏览器开发者工具（Network 标签）
3. 模拟网络错误（断开网络或使用浏览器工具模拟离线）
4. 等待 5 分钟（useAuth hook 的检查间隔）
5. 检查是否被意外登出
6. 恢复网络连接
7. 检查是否能正常访问

**预期结果**:
- ✅ **不应该**被意外登出（修复后）
- ✅ 恢复网络后能正常访问
- ✅ UI 可能显示加载状态，但不应该显示"未登录"

**修复前的问题**:
- ❌ 网络错误时会被意外登出
- ❌ 用户看到"未登录"但刷新页面后又能正常访问

---

### 3. Token 过期场景 ✅

**测试步骤**:
1. 登录系统
2. 打开浏览器开发者工具（Application > Cookies）
3. 找到 `pis-auth-token` cookie
4. 手动修改其值，使其无效（例如删除几个字符）
5. 访问 `/admin` 页面
6. 检查是否自动刷新 token
7. 检查是否能正常访问

**预期结果**:
- ✅ 中间件检测到 access token 无效
- ✅ 如果 refresh token 有效，自动刷新 access token
- ✅ 能正常访问页面

---

### 4. 页面导航场景 ✅

**测试步骤**:
1. 登录系统
2. 在 admin 页面之间导航（例如：`/admin` → `/admin/users` → `/admin/albums`）
3. 检查是否被意外登出
4. 检查认证状态是否保持一致

**预期结果**:
- ✅ 页面导航正常
- ✅ 不会被意外登出
- ✅ 认证状态保持一致

---

### 5. 并发请求场景 ✅

**测试步骤**:
1. 登录系统
2. 打开浏览器开发者工具（Network 标签）
3. 同时触发多个 API 请求（例如：加载用户列表、相册列表等）
4. 检查所有请求是否都能正常处理
5. 检查 token 是否正确刷新

**预期结果**:
- ✅ 所有请求都能正常处理
- ✅ Token 刷新逻辑正常工作
- ✅ 不会因为并发请求导致认证失败

---

### 6. 长时间使用场景 ⏰

**测试步骤**:
1. 登录系统
2. 保持登录状态超过 1 小时（access token 有效期）
3. 继续使用系统
4. 检查是否被意外登出
5. 检查 token 是否自动刷新

**预期结果**:
- ✅ Access token 过期后自动刷新
- ✅ 不会被意外登出
- ✅ 能继续正常使用系统

---

### 7. 浏览器标签页切换场景 ✅

**测试步骤**:
1. 登录系统
2. 打开多个浏览器标签页，都访问 admin 页面
3. 在一个标签页中登出
4. 检查其他标签页是否也被登出（应该会）
5. 检查是否所有标签页都跳转到登录页

**预期结果**:
- ✅ 在一个标签页登出后，其他标签页也应该被登出
- ✅ 所有标签页都跳转到登录页

**注意**: 这个功能可能需要额外的实现（例如：使用 BroadcastChannel API）

---

## 🔍 问题检查清单

### useAuth Hook 问题 ✅ **已修复**

- [x] 网络错误时不应该清除用户状态
- [x] 只有明确认证失败（401/403）时才清除用户状态
- [x] 服务器错误（500）不应该清除用户状态

### 中间件问题 ✅

- [x] Token 刷新逻辑正常工作
- [x] 访问 token 过期时自动刷新
- [x] Refresh token 过期时正确登出

### API Routes 问题 ✅

- [x] `/api/admin/*` 路由正确保护
- [x] 未登录访问返回 401/403
- [x] Token 刷新在中间件中处理

### 页面保护问题 ✅

- [x] `/admin/*` 页面正确保护
- [x] 未登录访问重定向到登录页
- [x] 已登录访问登录页重定向到 `/admin`

---

## 🐛 已知问题

### 1. 多个中间件实现 ⚠️ **待清理**

**问题**: 存在多个中间件实现（Supabase、兼容层等）

**影响**: 代码混淆，可能导致错误导入

**优先级**: 中

**修复建议**: 删除或标记未使用的中间件实现

---

## 📊 测试结果记录

### 测试日期: 2026-02-06

| 测试场景 | 状态 | 备注 |
|---------|------|------|
| 正常登录/登出 | ✅ 通过 | - |
| 网络错误场景 | ✅ 通过 | 修复后不再意外登出 |
| Token 过期场景 | ✅ 通过 | 自动刷新正常 |
| 页面导航场景 | ✅ 通过 | - |
| 并发请求场景 | ✅ 通过 | - |
| 长时间使用场景 | ⏳ 待测试 | 需要测试超过 1 小时 |
| 浏览器标签页切换 | ⏳ 待测试 | 可能需要额外实现 |

---

## 🛠️ 测试工具

### 1. 自动化测试脚本

```bash
# 运行认证会话测试
bash scripts/test/test-auth-session.sh
```

### 2. 手动测试步骤

1. 打开浏览器开发者工具
2. 查看 Network 标签（监控 API 请求）
3. 查看 Application > Cookies（查看认证 Cookie）
4. 查看 Console（查看日志和错误）

### 3. 模拟网络错误

**Chrome DevTools**:
1. 打开 Network 标签
2. 点击 "Offline" 按钮模拟离线
3. 或使用 "Throttling" 模拟慢速网络

**Firefox DevTools**:
1. 打开 Network 标签
2. 点击 "Throttling" 下拉菜单
3. 选择 "Offline" 或自定义速度

---

## 📝 测试报告模板

```markdown
## 测试报告 - [日期]

### 测试环境
- 浏览器: [Chrome/Firefox/Safari]
- 版本: [版本号]
- 操作系统: [macOS/Windows/Linux]

### 测试结果
1. 正常登录/登出: ✅/❌
2. 网络错误场景: ✅/❌
3. Token 过期场景: ✅/❌
4. 页面导航场景: ✅/❌
5. 并发请求场景: ✅/❌
6. 长时间使用场景: ✅/❌
7. 浏览器标签页切换: ✅/❌

### 发现的问题
- [问题描述]

### 建议
- [建议内容]
```

---

**最后更新**: 2026-02-06
