# ğŸ” å¯†ç è®¾ç½®é€»è¾‘åˆ†æ

## âœ… é—®é¢˜å·²ä¿®å¤

### æ•°æ®åº“é—®é¢˜
- **é—®é¢˜**: `users` è¡¨ç¼ºå°‘ `deleted_at` å­—æ®µï¼Œä½†ä»£ç ä¸­ä½¿ç”¨äº†å®ƒ
- **ä¿®å¤**: å·²æ·»åŠ  `deleted_at` å­—æ®µå’Œç´¢å¼•
- **çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ“‹ å¯†ç è®¾ç½®é€»è¾‘åˆ†æ

### æµç¨‹è¯´æ˜

#### 1. é¦–æ¬¡è®¾ç½®å¯†ç  (`/api/auth/setup-password`)

**åœºæ™¯ A: ç”¨æˆ·ä¸å­˜åœ¨ï¼Œç³»ç»Ÿæœªåˆå§‹åŒ–**
```typescript
// 1. æŸ¥æ‰¾ç”¨æˆ·
const user = await authDb.findUserByEmail(email)

// 2. ç”¨æˆ·ä¸å­˜åœ¨ï¼Œæ£€æŸ¥ç³»ç»Ÿæ˜¯å¦æœªåˆå§‹åŒ–
if (!user) {
  const hasAdmin = await authDb.hasAnyAdmin()
  const isSystemUninitialized = !hasAdmin
  
  // 3. å¦‚æœç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œåˆ›å»ºç¬¬ä¸€ä¸ªç®¡ç†å‘˜
  if (isSystemUninitialized) {
    await authDb.createUser(email, passwordHash)
    return success
  }
}
```

**åœºæ™¯ B: ç”¨æˆ·å­˜åœ¨ï¼Œä½†å¯†ç æœªè®¾ç½®**
```typescript
// 1. æŸ¥æ‰¾ç”¨æˆ·
const user = await authDb.findUserByEmail(email)

// 2. ç”¨æˆ·å­˜åœ¨ï¼Œæ›´æ–°å¯†ç 
if (user && !user.password_hash) {
  await authDb.updateUserPassword(user.id, passwordHash)
  return success
}
```

**åœºæ™¯ C: ç”¨æˆ·å­˜åœ¨ï¼Œå¯†ç å·²è®¾ç½®**
```typescript
// è¿”å›é”™è¯¯ï¼šå¯†ç å·²è®¾ç½®
return error('å¯†ç å·²è®¾ç½®ï¼Œè¯·ä½¿ç”¨ç™»å½•åŠŸèƒ½')
```

---

### 2. ç™»å½•é€»è¾‘ (`/api/auth/login`)

**æµç¨‹**:
1. æŸ¥æ‰¾ç”¨æˆ·ï¼ˆæ’é™¤å·²åˆ é™¤çš„ç”¨æˆ·ï¼‰
2. éªŒè¯å¯†ç å“ˆå¸Œ
3. ç”Ÿæˆ JWT token
4. æ›´æ–°æœ€åç™»å½•æ—¶é—´

**å…³é”®ç‚¹**:
- âœ… ä½¿ç”¨ `deleted_at IS NULL` æ’é™¤å·²åˆ é™¤ç”¨æˆ·
- âœ… æ”¯æŒ `password_hash` ä¸º `NULL` çš„æƒ…å†µï¼ˆé¦–æ¬¡ç™»å½•ï¼‰
- âœ… å¯†ç éªŒè¯ä½¿ç”¨ `pbkdf2` å“ˆå¸Œ

---

## ğŸ” å½“å‰çŠ¶æ€

### æ•°æ®åº“çŠ¶æ€
```sql
SELECT email, role, password_hash IS NOT NULL as has_password 
FROM users 
WHERE deleted_at IS NULL;
```

**ç»“æœ**:
- `admin@example.com` (admin) - å¯†ç å·²è®¾ç½® âœ…

### æµ‹è¯•å»ºè®®

1. **æµ‹è¯•é¦–æ¬¡è®¾ç½®å¯†ç **:
   ```bash
   curl -X POST http://localhost:3000/api/auth/setup-password \
     -H "Content-Type: application/json" \
     -d '{"email":"test@example.com","password":"test123456"}'
   ```

2. **æµ‹è¯•ç™»å½•**:
   ```bash
   curl -X POST http://localhost:3000/api/auth/login \
     -H "Content-Type: application/json" \
     -d '{"email":"admin@example.com","password":"your-password"}'
   ```

3. **æµ‹è¯•å·²å­˜åœ¨ç”¨æˆ·è®¾ç½®å¯†ç **:
   ```bash
   # ä½¿ç”¨å·²å­˜åœ¨ä½†å¯†ç ä¸ºç©ºçš„ç”¨æˆ·
   curl -X POST http://localhost:3000/api/auth/setup-password \
     -H "Content-Type: application/json" \
     -d '{"email":"admin@pis.com","password":"newpassword123"}'
   ```

---

## âœ… é€»è¾‘æ­£ç¡®æ€§éªŒè¯

### å¯†ç è®¾ç½®é€»è¾‘ âœ…

1. **é¦–æ¬¡è®¾ç½®ï¼ˆç³»ç»Ÿæœªåˆå§‹åŒ–ï¼‰**: âœ… æ­£ç¡®
   - æ£€æµ‹åˆ°ç³»ç»Ÿæœªåˆå§‹åŒ–
   - è‡ªåŠ¨åˆ›å»ºç¬¬ä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·
   - è®¾ç½®å¯†ç 

2. **å·²å­˜åœ¨ç”¨æˆ·è®¾ç½®å¯†ç **: âœ… æ­£ç¡®
   - æŸ¥æ‰¾ç”¨æˆ·
   - æ£€æŸ¥å¯†ç æ˜¯å¦å·²è®¾ç½®
   - æ›´æ–°å¯†ç 

3. **å¯†ç å·²è®¾ç½®çš„æƒ…å†µ**: âœ… æ­£ç¡®
   - è¿”å›é”™è¯¯ï¼Œæç¤ºä½¿ç”¨ç™»å½•åŠŸèƒ½

### ç™»å½•é€»è¾‘ âœ…

1. **ç”¨æˆ·æŸ¥æ‰¾**: âœ… æ­£ç¡®
   - ä½¿ç”¨ `deleted_at IS NULL` æ’é™¤å·²åˆ é™¤ç”¨æˆ·
   - é‚®ç®±è½¬æ¢ä¸ºå°å†™

2. **å¯†ç éªŒè¯**: âœ… æ­£ç¡®
   - ä½¿ç”¨ `pbkdf2` å“ˆå¸ŒéªŒè¯
   - æ”¯æŒ `password_hash` ä¸º `NULL`ï¼ˆé¦–æ¬¡ç™»å½•ï¼‰

3. **Token ç”Ÿæˆ**: âœ… æ­£ç¡®
   - ç”Ÿæˆ access token å’Œ refresh token
   - è®¾ç½®æ­£ç¡®çš„è¿‡æœŸæ—¶é—´

---

## ğŸ› å·²ä¿®å¤çš„é—®é¢˜

1. âœ… **æ•°æ®åº“å­—æ®µç¼ºå¤±**: å·²æ·»åŠ  `deleted_at` å­—æ®µ
2. âœ… **ç´¢å¼•ç¼ºå¤±**: å·²æ·»åŠ  `idx_users_deleted_at` ç´¢å¼•
3. âœ… **æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬**: å·²æ›´æ–°ï¼ŒåŒ…å« `deleted_at` å­—æ®µ

---

## ğŸ“ æ€»ç»“

**å¯†ç è®¾ç½®é€»è¾‘æ˜¯æ­£ç¡®çš„** âœ…

- âœ… é¦–æ¬¡è®¾ç½®æµç¨‹æ­£ç¡®
- âœ… å·²å­˜åœ¨ç”¨æˆ·è®¾ç½®å¯†ç æµç¨‹æ­£ç¡®
- âœ… é”™è¯¯å¤„ç†æ­£ç¡®
- âœ… æ•°æ®åº“æŸ¥è¯¢é€»è¾‘æ­£ç¡®ï¼ˆå·²ä¿®å¤ `deleted_at` å­—æ®µé—®é¢˜ï¼‰

**å»ºè®®**:
- é‡å¯å¼€å‘æœåŠ¡å™¨ï¼Œä½¿æ•°æ®åº“ä¿®å¤ç”Ÿæ•ˆ
- æµ‹è¯•å¯†ç è®¾ç½®å’Œç™»å½•åŠŸèƒ½
- éªŒè¯æ‰€æœ‰ç”¨æˆ·è§’è‰²è´¦æˆ·çš„å¯†ç è®¾ç½®

---

**æœ€åæ›´æ–°**: 2026-02-06
