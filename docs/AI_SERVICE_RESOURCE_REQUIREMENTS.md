# AI 服务资源需求与服务器配置指南

## 📋 概述

PIS 系统中的 AI 服务主要用于**人脸识别和特征提取**，支持相册中的人脸搜索功能。本文档详细说明 AI 服务的资源占用和服务器配置建议。

---

## 🔍 AI 服务功能说明

### 1. 人脸识别服务 (`services/ai`)

**功能**：
- 使用 InsightFace `buffalo_l` 模型检测和提取人脸特征
- 为上传的照片生成 512 维特征向量
- 支持相册中的人脸搜索功能（"找照片"功能）

**技术栈**：
- Python 3.9
- InsightFace (buffalo_l 模型)
- ONNX Runtime (CPU 执行)
- OpenCV (图像处理)
- FastAPI (HTTP 服务)

### 2. AI 修图功能

**注意**：当前实现的"AI 修图"实际上只是使用 Sharp 库进行简单的亮度/饱和度调整，**不是真正的 AI 模型**，资源占用很小。

---

## 💾 资源占用分析

### 模型文件大小

| 组件 | 大小 | 说明 |
|------|------|------|
| InsightFace buffalo_l 模型 | ~326 MB | 首次运行自动下载到 `~/.insightface/models` |
| 模型组件 | ~144 MB | 1k3d68.onnx (人脸关键点检测) |
| 其他模型文件 | ~182 MB | RetinaFace, ResNet50 等 |

### 运行时内存占用

| 场景 | 内存占用 | 说明 |
|------|----------|------|
| **服务启动（模型加载）** | ~800 MB - 1.2 GB | 模型加载到内存 |
| **空闲状态（模型常驻）** | ~600 MB - 1 GB | 模型常驻内存 |
| **处理单张照片** | +50-200 MB | 取决于图片大小 |
| **并发处理（3-5 张）** | +150-500 MB | 峰值内存 |

**内存占用估算**：
- 基础内存：600 MB - 1 GB（模型常驻）
- 处理峰值：+200-500 MB（取决于并发数）
- **推荐最小内存**：2 GB（仅 AI 服务）
- **推荐生产内存**：4 GB（AI 服务 + 系统开销）

### CPU 占用

| 场景 | CPU 占用 | 说明 |
|------|----------|------|
| **空闲状态** | < 1% | 仅保持服务运行 |
| **处理单张照片** | 20-40% | 单核 CPU 使用率 |
| **并发处理（3-5 张）** | 60-100% | 多核 CPU 利用率 |

**CPU 要求**：
- **最低**：2 核（处理较慢，但可用）
- **推荐**：4 核（较好的性能）
- **最佳**：8 核（高并发处理）

### 磁盘空间

| 组件 | 大小 | 说明 |
|------|------|------|
| Docker 镜像 | ~2-3 GB | 包含所有 Python 依赖 |
| 模型文件 | ~326 MB | 下载到容器内 |
| 日志和临时文件 | ~100-500 MB | 运行时产生 |

**磁盘空间要求**：
- **最小**：5 GB（仅 AI 服务）
- **推荐**：10 GB（包含日志和临时文件）

---

## 🖥️ 服务器配置建议

### 方案 1：最小配置（测试/小规模使用）

**适用场景**：
- 个人使用
- 照片数量 < 1000 张
- 并发上传 < 3 张/分钟

**配置**：
```
CPU: 2 核
内存: 4 GB（系统 2GB + AI 服务 2GB）
磁盘: 20 GB SSD
网络: 10 Mbps
```

**性能**：
- ✅ 可以运行，但处理速度较慢
- ⚠️ 并发处理能力有限
- ⚠️ 大图片处理可能超时

---

### 方案 2：推荐配置（中小规模生产环境）

**适用场景**：
- 小型工作室
- 照片数量 < 10,000 张
- 并发上传 < 10 张/分钟

**配置**：
```
CPU: 4 核
内存: 8 GB（系统 2GB + AI 服务 2GB + 其他服务 4GB）
磁盘: 50 GB SSD
网络: 50 Mbps
```

**性能**：
- ✅ 良好的处理性能
- ✅ 支持中等并发
- ✅ 响应时间 < 2 秒

---

### 方案 3：高性能配置（大规模生产环境）

**适用场景**：
- 专业摄影工作室
- 照片数量 > 10,000 张
- 高并发上传

**配置**：
```
CPU: 8 核或更多
内存: 16 GB（系统 4GB + AI 服务 4GB + 其他服务 8GB）
磁盘: 100 GB SSD（推荐 NVMe）
网络: 100 Mbps 或更高
```

**性能**：
- ✅ 优秀的处理性能
- ✅ 支持高并发
- ✅ 响应时间 < 1 秒

---

## 📊 完整系统资源分配

### 所有服务资源分配（推荐配置：8GB 内存）

| 服务 | 内存占用 | CPU 占用 | 说明 |
|------|----------|----------|------|
| **系统开销** | ~1 GB | - | 操作系统、Docker 等 |
| **PostgreSQL** | ~500 MB | 低 | 数据库 |
| **Redis** | ~200 MB | 低 | 任务队列/缓存 |
| **MinIO** | ~300 MB | 低 | 对象存储 |
| **Nginx** | ~50 MB | 低 | 反向代理 |
| **Next.js Web** | ~500 MB | 中 | 前端应用 |
| **Worker** | ~300 MB | 中-高 | 图片处理 |
| **AI 服务** | ~1-2 GB | 中-高 | 人脸识别 |
| **预留缓冲** | ~1 GB | - | 峰值和临时使用 |
| **总计** | ~5-6 GB | - | 8GB 内存足够 |

---

## ⚙️ 优化建议

### 1. 如果资源有限，可以禁用 AI 服务

**方法**：在 `docker-compose.yml` 中注释掉 AI 服务

```yaml
# ai:
#   build:
#     context: ..
#     dockerfile: services/ai/Dockerfile
#   ...
```

**影响**：
- ✅ 节省 ~1-2 GB 内存
- ✅ 节省 ~2-3 GB 磁盘空间
- ⚠️ 无法使用人脸搜索功能
- ✅ 其他功能正常

### 2. 限制 AI 服务资源（Docker Compose）

在 `docker-compose.yml` 中添加资源限制：

```yaml
ai:
  # ... 其他配置
  deploy:
    resources:
      limits:
        cpus: '2'      # 限制最多使用 2 核 CPU
        memory: 2G     # 限制最多使用 2GB 内存
      reservations:
        cpus: '1'      # 保证至少 1 核 CPU
        memory: 1G     # 保证至少 1GB 内存
```

### 3. 使用 GPU 加速（可选，需要 NVIDIA GPU）

如果服务器有 NVIDIA GPU，可以启用 GPU 加速：

```python
# services/ai/src/main.py
model = FaceAnalysis(
    name='buffalo_l',
    providers=['CUDAExecutionProvider', 'CPUExecutionProvider']  # GPU 优先
)
```

**优势**：
- ✅ 处理速度提升 5-10 倍
- ✅ CPU 占用大幅降低
- ⚠️ 需要 NVIDIA GPU 和 CUDA 支持

---

## 📈 性能监控

### 关键指标

1. **内存使用率**：应 < 80%
2. **CPU 使用率**：空闲时 < 10%，处理时 50-80%
3. **响应时间**：单张照片处理 < 3 秒
4. **错误率**：< 1%

### 监控命令

```bash
# 查看 AI 服务资源使用
docker stats pis-ai

# 查看 AI 服务日志
docker logs -f pis-ai

# 查看系统资源
htop  # 或 top
```

---

## 🎯 总结

### 最小可行配置
- **CPU**: 2 核
- **内存**: 4 GB
- **磁盘**: 20 GB

### 推荐生产配置
- **CPU**: 4 核
- **内存**: 8 GB
- **磁盘**: 50 GB SSD

### 高性能配置
- **CPU**: 8 核或更多
- **内存**: 16 GB
- **磁盘**: 100 GB NVMe SSD

### 关键建议

1. **内存是最重要的资源**：AI 服务模型需要常驻内存
2. **CPU 影响处理速度**：更多核心 = 更好的并发性能
3. **磁盘使用 SSD**：提升模型加载和图片处理速度
4. **如果资源有限**：可以禁用 AI 服务，其他功能不受影响

---

## 📚 相关文档

- [系统架构说明](./HOW_IT_WORKS.md)
- [部署指南](./SERVER_DEPLOYMENT_GUIDE.md)
- [Docker Compose 配置](../docker/docker-compose.yml)
