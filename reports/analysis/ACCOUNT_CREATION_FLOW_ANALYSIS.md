# ğŸ“‹ è´¦æˆ·åˆ›å»ºå’Œè®¾ç½®æµç¨‹å®Œæ•´åˆ†æ

**åˆ†ææ—¶é—´**: 2026-02-06  
**ç›®çš„**: æ£€æŸ¥ç®¡ç†å‘˜è´¦æˆ·å’Œå„è§’è‰²è´¦æˆ·çš„åˆ›å»ºå’Œè®¾ç½®æµç¨‹

---

## ğŸ¯ è´¦æˆ·åˆ›å»ºæ–¹å¼æ€»è§ˆ

ç³»ç»Ÿæä¾›äº†**5ç§**åˆ›å»ºè´¦æˆ·çš„æ–¹å¼ï¼š

### 1. **æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬** (`docker/init-postgresql-db.sql`) âœ…

**ç”¨é€”**: é¦–æ¬¡éƒ¨ç½²æ—¶è‡ªåŠ¨åˆ›å»ºæ‰€æœ‰è§’è‰²çš„é»˜è®¤è´¦æˆ·

**åˆ›å»ºçš„è§’è‰²**:
- âœ… `admin@pis.com` (ç®¡ç†å‘˜)
- âœ… `photographer@pis.com` (æ‘„å½±å¸ˆ)
- âœ… `retoucher@pis.com` (ä¿®å›¾å¸ˆ)
- âœ… `guest@pis.com` (è®¿å®¢)

**ç‰¹ç‚¹**:
- âœ… è‡ªåŠ¨æ‰§è¡Œï¼ˆPostgreSQL å®¹å™¨é¦–æ¬¡å¯åŠ¨æ—¶ï¼‰
- âœ… å¯†ç ä¸º `NULL`ï¼ˆé¦–æ¬¡ç™»å½•æ—¶è®¾ç½®ï¼‰
- âœ… ä½¿ç”¨ `ON CONFLICT DO NOTHING`ï¼ˆä¸ä¼šè¦†ç›–å·²å­˜åœ¨çš„è´¦æˆ·ï¼‰

**æ‰§è¡Œæ—¶æœº**:
- PostgreSQL å®¹å™¨é¦–æ¬¡å¯åŠ¨æ—¶
- æ•°æ®å·ä¸ºç©ºæ—¶

---

### 2. **æ‰¹é‡åˆå§‹åŒ–è„šæœ¬** (`scripts/utils/init-users.ts`) âœ…

**ç”¨é€”**: æ‰¹é‡åˆ›å»ºå„è§’è‰²çš„è´¦æˆ·

**å‘½ä»¤**:
```bash
pnpm init-users
```

**åˆ›å»ºçš„è§’è‰²**:
- âœ… `admin@pis.com` (ç®¡ç†å‘˜) - å¯é€šè¿‡ `INIT_ADMIN_EMAIL` è‡ªå®šä¹‰
- âœ… `photographer@pis.com` (æ‘„å½±å¸ˆ) - å¯é€šè¿‡ `INIT_PHOTOGRAPHER_EMAIL` è‡ªå®šä¹‰
- âœ… `retoucher@pis.com` (ä¿®å›¾å¸ˆ) - å¯é€šè¿‡ `INIT_RETOUCHER_EMAIL` è‡ªå®šä¹‰
- âœ… `guest@pis.com` (è®¿å®¢) - å¯é€šè¿‡ `INIT_GUEST_EMAIL` è‡ªå®šä¹‰

**ç‰¹ç‚¹**:
- âœ… æ”¯æŒç¯å¢ƒå˜é‡é…ç½®é‚®ç®±
- âœ… æ”¯æŒ `INIT_DEFAULT_PASSWORD` ç¯å¢ƒå˜é‡è®¾ç½®é»˜è®¤å¯†ç 
- âœ… å¦‚æœè´¦æˆ·å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºï¼ˆä¸ä¼šè¦†ç›–ï¼‰
- âœ… å¦‚æœå¯†ç æœªè®¾ç½®ï¼Œé¦–æ¬¡ç™»å½•æ—¶è®¾ç½®

**ç¯å¢ƒå˜é‡**:
```bash
INIT_ADMIN_EMAIL=admin@pis.com
INIT_PHOTOGRAPHER_EMAIL=photographer@pis.com
INIT_RETOUCHER_EMAIL=retoucher@pis.com
INIT_GUEST_EMAIL=guest@pis.com
INIT_DEFAULT_PASSWORD=your-password  # å¯é€‰
```

**ä½¿ç”¨åœºæ™¯**:
- éƒ¨ç½²åæ‰¹é‡åˆ›å»ºè´¦æˆ·
- è‡ªå®šä¹‰é‚®ç®±åŸŸå
- è®¾ç½®é»˜è®¤å¯†ç 

---

### 3. **å•ä¸ªè´¦æˆ·åˆ›å»ºè„šæœ¬** (`scripts/utils/create-admin.ts`) âœ…

**ç”¨é€”**: åˆ›å»ºå•ä¸ªè´¦æˆ·ï¼ˆæ”¯æŒæ‰€æœ‰è§’è‰²ï¼‰

**å‘½ä»¤**:
```bash
# äº¤äº’å¼
pnpm create-admin

# éäº¤äº’å¼
pnpm create-admin <email> <password> <role>
```

**æ”¯æŒçš„è§’è‰²**:
- âœ… `admin` (ç®¡ç†å‘˜ï¼Œé»˜è®¤)
- âœ… `photographer` (æ‘„å½±å¸ˆ)
- âœ… `retoucher` (ä¿®å›¾å¸ˆ)
- âœ… `guest` (è®¿å®¢)

**ç‰¹ç‚¹**:
- âœ… æ”¯æŒæ‰€æœ‰è§’è‰²
- âœ… å¯†ç å¯é€‰ï¼ˆç•™ç©ºåˆ™é¦–æ¬¡ç™»å½•æ—¶è®¾ç½®ï¼‰
- âœ… å¦‚æœè´¦æˆ·å·²å­˜åœ¨ï¼Œè¯¢é—®æ˜¯å¦æ›´æ–°å¯†ç 
- âœ… éªŒè¯é‚®ç®±æ ¼å¼å’Œå¯†ç é•¿åº¦

**ä½¿ç”¨åœºæ™¯**:
- åˆ›å»ºå•ä¸ªè´¦æˆ·
- åˆ›å»ºç‰¹å®šè§’è‰²çš„è´¦æˆ·
- æ›´æ–°è´¦æˆ·å¯†ç 

---

### 4. **Web API** (`/api/admin/users`) âœ…

**ç”¨é€”**: é€šè¿‡ Web ç•Œé¢åˆ›å»ºè´¦æˆ·ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰

**ç«¯ç‚¹**:
```
POST /api/admin/users
```

**è¯·æ±‚ä½“**:
```json
{
  "email": "user@example.com",
  "password": "optional-password",
  "role": "admin"  // å¯é€‰ï¼Œé»˜è®¤ admin
}
```

**ç‰¹ç‚¹**:
- âœ… éœ€è¦ç®¡ç†å‘˜æƒé™
- âœ… æ”¯æŒæ‰€æœ‰è§’è‰²
- âœ… å¯†ç å¯é€‰ï¼ˆç•™ç©ºåˆ™é¦–æ¬¡ç™»å½•æ—¶è®¾ç½®ï¼‰
- âœ… éªŒè¯é‚®ç®±å”¯ä¸€æ€§
- âœ… éªŒè¯è§’è‰²æœ‰æ•ˆæ€§

**ä½¿ç”¨åœºæ™¯**:
- ç®¡ç†å‘˜é€šè¿‡ Web ç•Œé¢åˆ›å»ºè´¦æˆ·
- æ‰¹é‡åˆ›å»ºè´¦æˆ·ï¼ˆé€šè¿‡ API è°ƒç”¨ï¼‰

---

### 5. **é¦–æ¬¡ç™»å½•è®¾ç½®å¯†ç ** (`/api/auth/setup-password`) âœ…

**ç”¨é€”**: é¦–æ¬¡ç™»å½•æ—¶è®¾ç½®å¯†ç ï¼ˆå¦‚æœè´¦æˆ·å¯†ç ä¸º `NULL`ï¼‰

**ç«¯ç‚¹**:
```
POST /api/auth/setup-password
```

**è¯·æ±‚ä½“**:
```json
{
  "email": "admin@pis.com",
  "password": "new-password",
  "confirmPassword": "new-password"
}
```

**ç‰¹ç‚¹**:
- âœ… å¦‚æœè´¦æˆ·ä¸å­˜åœ¨ä¸”ç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œè‡ªåŠ¨åˆ›å»ºç¬¬ä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·
- âœ… å¦‚æœè´¦æˆ·å­˜åœ¨ä½†å¯†ç ä¸º `NULL`ï¼Œè®¾ç½®å¯†ç 
- âœ… å¦‚æœè´¦æˆ·å·²è®¾ç½®å¯†ç ï¼Œè¿”å›é”™è¯¯
- âœ… é€Ÿç‡é™åˆ¶ä¿æŠ¤

**ä½¿ç”¨åœºæ™¯**:
- é¦–æ¬¡ç™»å½•è®¾ç½®å¯†ç 
- ç³»ç»Ÿæœªåˆå§‹åŒ–æ—¶åˆ›å»ºç¬¬ä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·

---

## ğŸ”„ è´¦æˆ·åˆ›å»ºæµç¨‹

### éƒ¨ç½²æµç¨‹

```
1. æ•°æ®åº“åˆå§‹åŒ– (init-postgresql-db.sql)
   â””â”€> åˆ›å»ºæ‰€æœ‰è§’è‰²çš„é»˜è®¤è´¦æˆ· (password_hash = NULL)
   
2. å¯†ç è®¾ç½® (init-postgresql.sh) [å¯é€‰]
   â””â”€> å¦‚æœè®¾ç½®äº† ADMIN_PASSWORDï¼Œæ›´æ–°ç¬¬ä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·çš„å¯†ç 
   
3. ç”¨æˆ·åˆå§‹åŒ– (pnpm init-users) [å¯é€‰]
   â””â”€> æ‰¹é‡åˆ›å»ºå„è§’è‰²è´¦æˆ·ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
   â””â”€> å¦‚æœè®¾ç½®äº† INIT_DEFAULT_PASSWORDï¼Œè®¾ç½®é»˜è®¤å¯†ç 
   
4. é¦–æ¬¡ç™»å½•
   â””â”€> å¦‚æœå¯†ç ä¸º NULLï¼Œæç¤ºè®¾ç½®å¯†ç 
   â””â”€> è°ƒç”¨ /api/auth/setup-password è®¾ç½®å¯†ç 
```

---

## ğŸ“Š è´¦æˆ·åˆ›å»ºæ–¹å¼å¯¹æ¯”

| æ–¹å¼ | è§’è‰²æ”¯æŒ | å¯†ç è®¾ç½® | æ‰§è¡Œæ—¶æœº | ä½¿ç”¨åœºæ™¯ |
|------|---------|---------|---------|---------|
| **æ•°æ®åº“åˆå§‹åŒ–** | âœ… æ‰€æœ‰è§’è‰² | âŒ NULL | é¦–æ¬¡å¯åŠ¨ | è‡ªåŠ¨åˆ›å»ºé»˜è®¤è´¦æˆ· |
| **init-users** | âœ… æ‰€æœ‰è§’è‰² | âœ… å¯é€‰ | æ‰‹åŠ¨æ‰§è¡Œ | æ‰¹é‡åˆ›å»º/è‡ªå®šä¹‰é‚®ç®± |
| **create-admin** | âœ… æ‰€æœ‰è§’è‰² | âœ… å¯é€‰ | æ‰‹åŠ¨æ‰§è¡Œ | åˆ›å»ºå•ä¸ªè´¦æˆ· |
| **Web API** | âœ… æ‰€æœ‰è§’è‰² | âœ… å¯é€‰ | è¿è¡Œæ—¶ | ç®¡ç†å‘˜é€šè¿‡ç•Œé¢åˆ›å»º |
| **setup-password** | âš ï¸ ä»…ç®¡ç†å‘˜ | âœ… å¿…å¡« | é¦–æ¬¡ç™»å½• | é¦–æ¬¡ç™»å½•è®¾ç½®å¯†ç  |

---

## âœ… ä¸€è‡´æ€§æ£€æŸ¥

### 1. **é‚®ç®±ä¸€è‡´æ€§** âœ…

| è„šæœ¬ | ç®¡ç†å‘˜é‚®ç®± | çŠ¶æ€ |
|------|-----------|------|
| `init-postgresql-db.sql` | `admin@pis.com` | âœ… |
| `init-users.ts` | `admin@pis.com` (é»˜è®¤) | âœ… |
| `create-admin.ts` | ç”¨æˆ·æŒ‡å®š | âœ… |
| `deploy.sh` | `admin@pis.com` | âœ… |

**ç»“è®º**: âœ… æ‰€æœ‰è„šæœ¬ä½¿ç”¨ä¸€è‡´çš„é»˜è®¤é‚®ç®± `admin@pis.com`

---

### 2. **è§’è‰²ä¸€è‡´æ€§** âœ…

| è„šæœ¬ | æ”¯æŒçš„è§’è‰² | çŠ¶æ€ |
|------|-----------|------|
| `init-postgresql-db.sql` | admin, photographer, retoucher, guest | âœ… |
| `init-users.ts` | admin, photographer, retoucher, guest | âœ… |
| `create-admin.ts` | admin, photographer, retoucher, guest | âœ… |
| `Web API` | admin, photographer, retoucher, guest | âœ… |

**ç»“è®º**: âœ… æ‰€æœ‰è„šæœ¬æ”¯æŒç›¸åŒçš„ 4 ä¸ªè§’è‰²

---

### 3. **å¯†ç å¤„ç†ä¸€è‡´æ€§** âœ…

| è„šæœ¬ | å¯†ç å¤„ç† | çŠ¶æ€ |
|------|---------|------|
| `init-postgresql-db.sql` | `password_hash = NULL` | âœ… |
| `init-users.ts` | æ”¯æŒ `INIT_DEFAULT_PASSWORD` | âœ… |
| `create-admin.ts` | å¯†ç å¯é€‰ | âœ… |
| `Web API` | å¯†ç å¯é€‰ | âœ… |
| `setup-password` | é¦–æ¬¡ç™»å½•è®¾ç½® | âœ… |

**ç»“è®º**: âœ… æ‰€æœ‰è„šæœ¬ä¸€è‡´æ”¯æŒå¯†ç ä¸º `NULL`ï¼ˆé¦–æ¬¡ç™»å½•è®¾ç½®ï¼‰

---

### 4. **å¯†ç å“ˆå¸Œç®—æ³•ä¸€è‡´æ€§** âœ…

| è„šæœ¬ | ç®—æ³• | æ ¼å¼ | çŠ¶æ€ |
|------|------|------|------|
| `init-users.ts` | PBKDF2-SHA512 | `salt:iterations:hash` | âœ… |
| `create-admin.ts` | PBKDF2-SHA512 | `salt:iterations:hash` | âœ… |
| `create-admin-inline.js` | PBKDF2-SHA512 | `salt:iterations:hash` | âœ… |
| `init-postgresql.sh` | PBKDF2-SHA512 | `salt:iterations:hash` | âœ… |
| `Web API` | PBKDF2-SHA512 | `salt:iterations:hash` | âœ… |

**å‚æ•°**:
- Salt: 32 bytes (hex)
- Iterations: 100,000
- Key length: 64 bytes
- Digest: SHA-512

**ç»“è®º**: âœ… æ‰€æœ‰è„šæœ¬ä½¿ç”¨ç›¸åŒçš„å¯†ç å“ˆå¸Œç®—æ³•å’Œå‚æ•°

---

## ğŸ” å‘ç°çš„é—®é¢˜

### 1. **æµ‹è¯•è„šæœ¬è¯¯æŠ¥** âš ï¸

**é—®é¢˜**: æµ‹è¯•è„šæœ¬ä¸­çš„é‚®ç®±ä¸€è‡´æ€§æ£€æŸ¥æœ‰è¯¯æŠ¥

**åŸå› **: `grep` å‘½ä»¤æå–é‚®ç®±æ—¶åŒ…å«äº†é¢å¤–çš„å­—ç¬¦

**çŠ¶æ€**: âœ… å®é™…ä»£ç æ˜¯æ­£ç¡®çš„ï¼Œåªæ˜¯æµ‹è¯•è„šæœ¬éœ€è¦ä¼˜åŒ–

---

### 2. **è§’è‰²æ•°é‡æ£€æŸ¥è¯¯æŠ¥** âš ï¸

**é—®é¢˜**: æµ‹è¯•è„šæœ¬ä¸­çš„è§’è‰²æ•°é‡æ£€æŸ¥æœ‰è¯¯æŠ¥

**åŸå› **: `grep` å‘½ä»¤ç»Ÿè®¡æ–¹å¼ä¸å‡†ç¡®

**çŠ¶æ€**: âœ… å®é™…ä»£ç æ”¯æŒæ‰€æœ‰ 4 ä¸ªè§’è‰²ï¼Œåªæ˜¯æµ‹è¯•è„šæœ¬éœ€è¦ä¼˜åŒ–

---

## âœ… éªŒè¯ç»“æœ

### æµ‹è¯•é€šè¿‡é¡¹ (17/19)

1. âœ… `init-users.ts` å­˜åœ¨ä¸”æ”¯æŒæ‰€æœ‰è§’è‰²
2. âœ… `init-users.ts` æ”¯æŒç¯å¢ƒå˜é‡é…ç½®é‚®ç®±
3. âœ… `init-users.ts` æ”¯æŒ `INIT_DEFAULT_PASSWORD` ç¯å¢ƒå˜é‡
4. âœ… `create-admin.ts` å­˜åœ¨ä¸”æ”¯æŒæ‰€æœ‰è§’è‰²
5. âœ… æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬åˆ›å»ºæ‰€æœ‰è§’è‰²çš„è´¦æˆ·
6. âœ… æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬è®¾ç½® `password_hash` ä¸º `NULL`
7. âœ… `setup-password` API å­˜åœ¨ä¸”æ”¯æŒé¦–æ¬¡ç™»å½•è®¾ç½®å¯†ç 
8. âœ… `init-postgresql.sh` æ”¯æŒ `ADMIN_PASSWORD` ç¯å¢ƒå˜é‡
9. âœ… `one-click-deploy.sh` ä½¿ç”¨ `pnpm init-users` åˆ›å»ºè´¦æˆ·
10. âœ… `deploy.sh` æ”¯æŒåˆ›å»ºç®¡ç†å‘˜è´¦æˆ·

### æµ‹è¯•å¤±è´¥é¡¹ (2/19)

1. âš ï¸ é‚®ç®±ä¸€è‡´æ€§æ£€æŸ¥è¯¯æŠ¥ï¼ˆå®é™…ä»£ç æ­£ç¡®ï¼‰
2. âš ï¸ è§’è‰²æ•°é‡æ£€æŸ¥è¯¯æŠ¥ï¼ˆå®é™…ä»£ç æ­£ç¡®ï¼‰

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. **éƒ¨ç½²æ—¶åˆ›å»ºè´¦æˆ·**

**æ¨èæµç¨‹**:
```bash
# 1. æ•°æ®åº“åˆå§‹åŒ–ï¼ˆè‡ªåŠ¨ï¼‰
docker compose up -d postgres

# 2. æ‰¹é‡åˆ›å»ºè´¦æˆ·ï¼ˆå¯é€‰ï¼Œå¦‚æœæ•°æ®åº“åˆå§‹åŒ–å·²åˆ›å»ºåˆ™è·³è¿‡ï¼‰
pnpm init-users

# 3. é¦–æ¬¡ç™»å½•è®¾ç½®å¯†ç 
# è®¿é—® http://localhost:3000/admin/login
# è¾“å…¥é‚®ç®±ï¼Œç³»ç»Ÿä¼šæç¤ºè®¾ç½®å¯†ç 
```

---

### 2. **è‡ªå®šä¹‰é‚®ç®±**

**æ–¹å¼ 1**: ä½¿ç”¨ç¯å¢ƒå˜é‡
```bash
export INIT_ADMIN_EMAIL=admin@yourdomain.com
export INIT_PHOTOGRAPHER_EMAIL=photographer@yourdomain.com
pnpm init-users
```

**æ–¹å¼ 2**: ä½¿ç”¨ `create-admin` è„šæœ¬
```bash
pnpm create-admin admin@yourdomain.com password admin
```

---

### 3. **è®¾ç½®é»˜è®¤å¯†ç **

**æ–¹å¼ 1**: ä½¿ç”¨ç¯å¢ƒå˜é‡
```bash
export INIT_DEFAULT_PASSWORD=your-secure-password
pnpm init-users
```

**æ–¹å¼ 2**: ä½¿ç”¨ `create-admin` è„šæœ¬
```bash
pnpm create-admin admin@pis.com your-password admin
```

---

### 4. **åˆ›å»ºç‰¹å®šè§’è‰²è´¦æˆ·**

**ä½¿ç”¨ `create-admin` è„šæœ¬**:
```bash
# åˆ›å»ºæ‘„å½±å¸ˆè´¦æˆ·
pnpm create-admin photographer@example.com password123 photographer

# åˆ›å»ºä¿®å›¾å¸ˆè´¦æˆ·
pnpm create-admin retoucher@example.com password123 retoucher

# åˆ›å»ºè®¿å®¢è´¦æˆ·
pnpm create-admin guest@example.com password123 guest
```

---

## ğŸ“ æ€»ç»“

### âœ… è´¦æˆ·åˆ›å»ºæµç¨‹å®Œæ•´ä¸”ä¸€è‡´

1. **æ•°æ®åº“åˆå§‹åŒ–**: è‡ªåŠ¨åˆ›å»ºæ‰€æœ‰è§’è‰²çš„é»˜è®¤è´¦æˆ·
2. **æ‰¹é‡åˆå§‹åŒ–**: æ”¯æŒç¯å¢ƒå˜é‡é…ç½®ï¼Œæ‰¹é‡åˆ›å»ºè´¦æˆ·
3. **å•ä¸ªåˆ›å»º**: æ”¯æŒæ‰€æœ‰è§’è‰²ï¼Œçµæ´»åˆ›å»ºè´¦æˆ·
4. **Web API**: ç®¡ç†å‘˜é€šè¿‡ç•Œé¢åˆ›å»ºè´¦æˆ·
5. **é¦–æ¬¡ç™»å½•**: è‡ªåŠ¨è®¾ç½®å¯†ç æˆ–åˆ›å»ºç¬¬ä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·

### âœ… ä¸€è‡´æ€§è‰¯å¥½

- âœ… é‚®ç®±ä¸€è‡´ï¼ˆé»˜è®¤ `admin@pis.com`ï¼‰
- âœ… è§’è‰²ä¸€è‡´ï¼ˆ4 ä¸ªè§’è‰²ï¼‰
- âœ… å¯†ç å¤„ç†ä¸€è‡´ï¼ˆæ”¯æŒ `NULL`ï¼‰
- âœ… å¯†ç å“ˆå¸Œç®—æ³•ä¸€è‡´ï¼ˆPBKDF2-SHA512ï¼‰

### âœ… å®‰å…¨æ€§

- âœ… å¯†ç å“ˆå¸Œä½¿ç”¨ PBKDF2-SHA512ï¼ˆ100,000 æ¬¡è¿­ä»£ï¼‰
- âœ… é¦–æ¬¡ç™»å½•è®¾ç½®å¯†ç ï¼ˆé¿å…é»˜è®¤å¯†ç ï¼‰
- âœ… é€Ÿç‡é™åˆ¶ä¿æŠ¤
- âœ… é‚®ç®±å”¯ä¸€æ€§éªŒè¯

---

**æœ€åæ›´æ–°**: 2026-02-06
