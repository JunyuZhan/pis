# ğŸš¨ PIS ç™»å½•é¡µé¢å…³é”® Bug ä¿®å¤

**ä¿®å¤æ—¶é—´**: 2026-02-06  
**é—®é¢˜ä¸¥é‡æ€§**: ğŸ”´ **ä¸¥é‡** - å¯¼è‡´ç”¨æˆ·åç™»å½•å¤±è´¥

---

## ğŸ› å‘ç°çš„é—®é¢˜

### é—®é¢˜æè¿°

**ç™»å½•é¡µé¢ç¡¬ç¼–ç äº†é”™è¯¯çš„ç®¡ç†å‘˜é‚®ç®±**

**ä½ç½®**: `apps/web/src/app/admin/login/page.tsx`

**é—®é¢˜ä»£ç **:
```typescript
// å›ºå®šç®¡ç†å‘˜é‚®ç®±å’Œç”¨æˆ·åæ˜ å°„
const ADMIN_EMAIL = 'admin@example.com'  // âŒ ç¡¬ç¼–ç é”™è¯¯

const getEmailForLogin = (): string => {
  if (loginType === 'username') {
    if (username.toLowerCase() === ADMIN_USERNAME.toLowerCase()) {
      return ADMIN_EMAIL  // âŒ è¿”å›ç¡¬ç¼–ç çš„ admin@example.com
    }
  }
  // ...
}
```

**å®é™…æƒ…å†µ**:
- æ•°æ®åº“ä¸­çš„å®é™…ç®¡ç†å‘˜é‚®ç®±: `admin@pis.com`
- ç™»å½•é¡µé¢ç¡¬ç¼–ç çš„é‚®ç®±: `admin@example.com`
- **ç»“æœ**: ä½¿ç”¨ç”¨æˆ·å "admin" ç™»å½•æ—¶ï¼Œå‰ç«¯å‘é€ `admin@example.com` åˆ° APIï¼Œä½†æ•°æ®åº“ä¸­ä¸å­˜åœ¨è¿™ä¸ªç”¨æˆ·ï¼Œå¯¼è‡´ç™»å½•å¤±è´¥

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤å†…å®¹

1. **ç§»é™¤ç¡¬ç¼–ç çš„ç®¡ç†å‘˜é‚®ç®±**
   - åˆ é™¤ `const ADMIN_EMAIL = 'admin@example.com'`
   - æ·»åŠ åŠ¨æ€çŠ¶æ€ `adminEmail` æ¥å­˜å‚¨ä» API è·å–çš„å®é™…ç®¡ç†å‘˜é‚®ç®±

2. **åŠ¨æ€è·å–ç®¡ç†å‘˜é‚®ç®±**
   - åœ¨ `checkAdminStatus()` å‡½æ•°ä¸­ï¼Œä¿å­˜ API è¿”å›çš„å®é™…ç®¡ç†å‘˜é‚®ç®±
   - ä½¿ç”¨ `setAdminEmail(data.email)` ä¿å­˜

3. **ä¿®å¤ `getEmailForLogin()` å‡½æ•°**
   - å¦‚æœå·²è·å–åˆ°ç®¡ç†å‘˜é‚®ç®±ï¼Œä½¿ç”¨å®ƒ
   - å¦‚æœè¿˜æœªè·å–åˆ°ï¼Œå‘é€ "admin" è®©æœåŠ¡ç«¯å¤„ç†ï¼ˆæœåŠ¡ç«¯ä¼šåŠ¨æ€æŸ¥æ‰¾ï¼‰

4. **ä¿®å¤å¯†ç è®¾ç½®æµç¨‹**
   - ä½¿ç”¨åŠ¨æ€è·å–çš„ç®¡ç†å‘˜é‚®ç®±ï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç çš„å€¼

---

## ğŸ”§ ä¿®å¤åçš„ä»£ç 

### 1. çŠ¶æ€ç®¡ç†

```typescript
// åŠ¨æ€è·å–çš„ç®¡ç†å‘˜é‚®ç®±ï¼ˆä» check-admin-status API è·å–ï¼‰
const [adminEmail, setAdminEmail] = useState<string | null>(null)
```

### 2. è·å–ç®¡ç†å‘˜é‚®ç®±

```typescript
const checkAdminStatus = async () => {
  // ...
  const data = await response.json()
  
  // âš ï¸ é‡è¦ï¼šä¿å­˜å®é™…çš„ç®¡ç†å‘˜é‚®ç®±ï¼ˆç”¨äºç”¨æˆ·åç™»å½•ï¼‰
  if (data.email) {
    setAdminEmail(data.email)
  }
  // ...
}
```

### 3. ä¿®å¤ç™»å½•é‚®ç®±è½¬æ¢

```typescript
const getEmailForLogin = (): string => {
  if (loginType === 'username') {
    // ç”¨æˆ·åç™»å½•ï¼šåŠ¨æ€æ˜ å°„åˆ°å®é™…çš„ç®¡ç†å‘˜é‚®ç®±
    // âš ï¸ é‡è¦ï¼šä½¿ç”¨ä» check-admin-status API è·å–çš„å®é™…ç®¡ç†å‘˜é‚®ç®±
    // å¦‚æœè¿˜æ²¡æœ‰è·å–åˆ°ï¼Œå‘é€ "admin" è®©æœåŠ¡ç«¯å¤„ç†ï¼ˆæœåŠ¡ç«¯ä¼šåŠ¨æ€æŸ¥æ‰¾ï¼‰
    if (username.toLowerCase() === ADMIN_USERNAME.toLowerCase()) {
      return adminEmail || 'admin'  // âœ… ä½¿ç”¨åŠ¨æ€é‚®ç®±æˆ–è®©æœåŠ¡ç«¯å¤„ç†
    }
    return ''
  } else {
    return email.trim()
  }
}
```

### 4. ä¿®å¤å¯†ç è®¾ç½®

```typescript
body: JSON.stringify({
  email: adminEmail || 'admin@pis.com', // âœ… ä½¿ç”¨åŠ¨æ€è·å–çš„ç®¡ç†å‘˜é‚®ç®±
  password: newPassword,
  confirmPassword,
}),
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: ç”¨æˆ·åç™»å½• âœ…

1. ç”¨æˆ·è¾“å…¥ç”¨æˆ·å "admin"
2. å‰ç«¯è°ƒç”¨ `getEmailForLogin()`ï¼Œè¿”å› `adminEmail`ï¼ˆä¾‹å¦‚ `admin@pis.com`ï¼‰
3. å‘é€ç™»å½•è¯·æ±‚åˆ° `/api/auth/login`ï¼Œé‚®ç®±ä¸º `admin@pis.com`
4. **é¢„æœŸ**: ç™»å½•æˆåŠŸï¼ˆå¦‚æœå¯†ç æ­£ç¡®ï¼‰

### åœºæ™¯ 2: é‚®ç®±ç™»å½• âœ…

1. ç”¨æˆ·è¾“å…¥é‚®ç®± `admin@pis.com`
2. å‰ç«¯ç›´æ¥ä½¿ç”¨è¾“å…¥çš„é‚®ç®±
3. å‘é€ç™»å½•è¯·æ±‚åˆ° `/api/auth/login`
4. **é¢„æœŸ**: ç™»å½•æˆåŠŸï¼ˆå¦‚æœå¯†ç æ­£ç¡®ï¼‰

### åœºæ™¯ 3: æœåŠ¡ç«¯å¤„ç† "admin" âœ…

1. å¦‚æœå‰ç«¯è¿˜æœªè·å–åˆ°ç®¡ç†å‘˜é‚®ç®±ï¼Œå‘é€ "admin"
2. æœåŠ¡ç«¯æ£€æµ‹åˆ° "admin"ï¼ŒåŠ¨æ€æŸ¥æ‰¾ç¬¬ä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·
3. ä½¿ç”¨æ‰¾åˆ°çš„ç®¡ç†å‘˜é‚®ç®±è¿›è¡Œç™»å½•
4. **é¢„æœŸ**: ç™»å½•æˆåŠŸï¼ˆå¦‚æœå¯†ç æ­£ç¡®ï¼‰

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| ç”¨æˆ·å "admin" ç™»å½• | âŒ å‘é€ `admin@example.com`ï¼Œç™»å½•å¤±è´¥ | âœ… å‘é€å®é™…ç®¡ç†å‘˜é‚®ç®±ï¼Œç™»å½•æˆåŠŸ |
| é‚®ç®±ç™»å½• | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ |
| å¯†ç è®¾ç½® | âŒ ä½¿ç”¨ç¡¬ç¼–ç é‚®ç®± | âœ… ä½¿ç”¨åŠ¨æ€é‚®ç®± |

---

## âœ… ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰çš„é—®é¢˜

- âŒ ç”¨æˆ·å "admin" ç™»å½•å¤±è´¥ï¼ˆå‘é€é”™è¯¯çš„é‚®ç®±ï¼‰
- âŒ å¯†ç è®¾ç½®å¯èƒ½ä½¿ç”¨é”™è¯¯çš„é‚®ç®±
- âŒ å‰ç«¯å’ŒæœåŠ¡ç«¯é‚®ç®±ä¸ä¸€è‡´

### ä¿®å¤åçš„æ•ˆæœ

- âœ… ç”¨æˆ·å "admin" ç™»å½•æˆåŠŸï¼ˆä½¿ç”¨æ­£ç¡®çš„é‚®ç®±ï¼‰
- âœ… å¯†ç è®¾ç½®ä½¿ç”¨æ­£ç¡®çš„é‚®ç®±
- âœ… å‰ç«¯å’ŒæœåŠ¡ç«¯é‚®ç®±ä¸€è‡´
- âœ… æ”¯æŒåŠ¨æ€ç®¡ç†å‘˜é‚®ç®±ï¼ˆä¸ä¾èµ–ç¡¬ç¼–ç ï¼‰

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

- âœ… `apps/web/src/app/admin/login/page.tsx` - **å·²ä¿®å¤**
- âœ… `apps/web/src/app/api/auth/login/route.ts` - å·²æ”¯æŒåŠ¨æ€æŸ¥æ‰¾ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
- âœ… `apps/web/src/app/api/auth/check-admin-status/route.ts` - å·²è¿”å›å®é™…é‚®ç®±ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰

---

## ğŸ¯ å…³é”®æ”¹è¿›

1. **åŠ¨æ€é‚®ç®±è·å–** âœ…
   - ä¸å†ç¡¬ç¼–ç ç®¡ç†å‘˜é‚®ç®±
   - ä» API åŠ¨æ€è·å–å®é™…çš„ç®¡ç†å‘˜é‚®ç®±

2. **å‘åå…¼å®¹** âœ…
   - å¦‚æœè¿˜æœªè·å–åˆ°ç®¡ç†å‘˜é‚®ç®±ï¼Œå‘é€ "admin" è®©æœåŠ¡ç«¯å¤„ç†
   - æœåŠ¡ç«¯å·²ç»æ”¯æŒåŠ¨æ€æŸ¥æ‰¾ç®¡ç†å‘˜é‚®ç®±

3. **ä¸€è‡´æ€§** âœ…
   - å‰ç«¯å’ŒæœåŠ¡ç«¯ä½¿ç”¨ç›¸åŒçš„é‚®ç®±
   - å¯†ç è®¾ç½®å’Œç™»å½•ä½¿ç”¨ç›¸åŒçš„é‚®ç®±

---

**æœ€åæ›´æ–°**: 2026-02-06
