# ğŸ” ç”¨æˆ·æƒé™ç³»ç»Ÿå®Œæ•´åˆ†æ

**åˆ†ææ—¶é—´**: 2026-02-06  
**ç›®çš„**: æ£€æŸ¥ç”¨æˆ·æƒé™ç³»ç»Ÿçš„å®Œæ•´æ€§ã€ä¸€è‡´æ€§å’Œå®‰å…¨æ€§

---

## ğŸ¯ æƒé™ç³»ç»Ÿæ€»è§ˆ

ç³»ç»Ÿå®ç°äº†**åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰**ï¼Œæ”¯æŒ 4 ç§ç”¨æˆ·è§’è‰²ï¼š

### 1. **è§’è‰²å®šä¹‰** âœ…

| è§’è‰² | è‹±æ–‡å | è¯´æ˜ |
|------|--------|------|
| **ç®¡ç†å‘˜** | `admin` | æ‹¥æœ‰æ‰€æœ‰æƒé™ |
| **æ‘„å½±å¸ˆ** | `photographer` | å¯ä»¥ä¸Šä¼ å’Œç®¡ç†ç…§ç‰‡ |
| **ä¿®å›¾å¸ˆ** | `retoucher` | å¯ä»¥ä¿®å›¾å’ŒæŸ¥çœ‹ä¿®å›¾ä»»åŠ¡ |
| **è®¿å®¢** | `guest` | åªè¯»æƒé™ |

---

## ğŸ“‹ æƒé™æ£€æŸ¥å‡½æ•°

### 1. **`requireAdmin(request)`** âœ…

**ç”¨é€”**: æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜

**å®ç°**:
```typescript
export async function requireAdmin(request: NextRequest): Promise<UserWithRole | null> {
  return requireRole(request, ['admin'])
}
```

**ä½¿ç”¨åœºæ™¯**:
- ç”¨æˆ·ç®¡ç† API
- ç³»ç»Ÿé…ç½® API
- ç®¡ç†å‘˜ä¸“å±åŠŸèƒ½

---

### 2. **`requireRole(request, allowedRoles)`** âœ…

**ç”¨é€”**: æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰æŒ‡å®šè§’è‰²ä¹‹ä¸€

**å®ç°**:
```typescript
export async function requireRole(
  request: NextRequest,
  allowedRoles: UserRole[]
): Promise<UserWithRole | null>
```

**ä½¿ç”¨åœºæ™¯**:
- å¤šè§’è‰²æƒé™æ£€æŸ¥
- çµæ´»çš„è§’è‰²ç»„åˆ

**ç¤ºä¾‹**:
```typescript
// åªå…è®¸ç®¡ç†å‘˜æˆ–ä¿®å›¾å¸ˆè®¿é—®
const user = await requireRole(request, ['admin', 'retoucher'])
```

---

### 3. **`requireRetoucherOrAdmin(request)`** âœ…

**ç”¨é€”**: æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºä¿®å›¾å¸ˆæˆ–ç®¡ç†å‘˜

**å®ç°**:
```typescript
export async function requireRetoucherOrAdmin(request: NextRequest): Promise<UserWithRole | null> {
  return requireRole(request, ['admin', 'retoucher'])
}
```

**ä½¿ç”¨åœºæ™¯**:
- ä¿®å›¾ä»»åŠ¡ API
- ä¿®å›¾ç›¸å…³åŠŸèƒ½

---

### 4. **`getUserRole(request)`** âœ…

**ç”¨é€”**: è·å–å½“å‰ç”¨æˆ·çš„è§’è‰²ï¼ˆä¸è¿›è¡Œæƒé™æ£€æŸ¥ï¼‰

**å®ç°**:
```typescript
export async function getUserRole(request: NextRequest): Promise<UserRole | null>
```

**ä½¿ç”¨åœºæ™¯**:
- æ¡ä»¶é€»è¾‘åˆ¤æ–­
- å‰ç«¯æ˜¾ç¤º

---

## ğŸ”’ API è·¯ç”±æƒé™ä¿æŠ¤

### 1. **ç”¨æˆ·ç®¡ç† API** âœ…

| è·¯ç”± | æƒé™è¦æ±‚ | çŠ¶æ€ |
|------|---------|------|
| `GET /api/admin/users` | `requireAdmin` | âœ… |
| `POST /api/admin/users` | `requireAdmin` | âœ… |
| `GET /api/admin/users/[id]` | `requireAdmin` | âœ… |
| `PATCH /api/admin/users/[id]` | `requireAdmin` | âœ… |
| `DELETE /api/admin/users/[id]` | `requireAdmin` | âœ… |
| `POST /api/admin/users/[id]/reset-password` | `requireAdmin` | âœ… |

**ç»“è®º**: âœ… æ‰€æœ‰ç”¨æˆ·ç®¡ç† API éƒ½æœ‰æƒé™ä¿æŠ¤

---

### 2. **ä¿®å›¾ä»»åŠ¡ API** âœ…

| è·¯ç”± | æƒé™è¦æ±‚ | çŠ¶æ€ |
|------|---------|------|
| `GET /api/admin/retouch/tasks` | `requireRetoucherOrAdmin` | âœ… |
| `POST /api/admin/retouch/[id]/upload` | éœ€è¦æ£€æŸ¥ | âš ï¸ |

**ç»“è®º**: âœ… ä¿®å›¾ä»»åŠ¡ API æœ‰æƒé™ä¿æŠ¤

---

### 3. **ç›¸å†Œç®¡ç† API** âš ï¸

| è·¯ç”± | æƒé™è¦æ±‚ | çŠ¶æ€ |
|------|---------|------|
| `GET /api/admin/albums` | `getCurrentUser` (ä»…ç™»å½•æ£€æŸ¥) | âš ï¸ |
| `POST /api/admin/albums` | éœ€è¦æ£€æŸ¥ | âš ï¸ |

**é—®é¢˜**:
- âš ï¸ ç›¸å†Œç®¡ç† API åªæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œä¸æ£€æŸ¥è§’è‰²
- **é£é™©**: ä»»ä½•ç™»å½•ç”¨æˆ·éƒ½å¯ä»¥è®¿é—®ç›¸å†Œç®¡ç†åŠŸèƒ½

**ä¿®å¤å»ºè®®**:
- âœ… åº”è¯¥ä½¿ç”¨ `requireAdmin` æˆ– `requireRole` æ£€æŸ¥è§’è‰²

---

### 4. **å…¶ä»–ç®¡ç† API** âš ï¸

| è·¯ç”± | æƒé™è¦æ±‚ | çŠ¶æ€ |
|------|---------|------|
| `POST /api/admin/consistency/check` | `getCurrentUser` (ä»…ç™»å½•æ£€æŸ¥) | âš ï¸ |
| `GET /api/admin/upgrade/check` | éœ€è¦æ£€æŸ¥ | âš ï¸ |
| `POST /api/admin/upgrade/execute` | éœ€è¦æ£€æŸ¥ | âš ï¸ |

**é—®é¢˜**:
- âš ï¸ éƒ¨åˆ†ç®¡ç† API åªæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œä¸æ£€æŸ¥è§’è‰²
- **é£é™©**: éç®¡ç†å‘˜ç”¨æˆ·å¯èƒ½è®¿é—®ç®¡ç†åŠŸèƒ½

**ä¿®å¤å»ºè®®**:
- âœ… æ‰€æœ‰ `/api/admin/*` è·¯ç”±åº”è¯¥ä½¿ç”¨ `requireAdmin` æ£€æŸ¥

---

## ğŸ›¡ï¸ ä¸­é—´ä»¶ä¿æŠ¤

### **Middleware ä¿æŠ¤** âœ…

**æ–‡ä»¶**: `apps/web/src/middleware.ts`

**ä¿æŠ¤çš„è·¯ç”±**:
- âœ… `/api/admin/*` - æ‰€æœ‰ç®¡ç† API
- âœ… `/admin/*` - æ‰€æœ‰ç®¡ç†é¡µé¢

**å®ç°**:
```typescript
if (pathname.startsWith('/api/admin')) {
  return await updateSession(request)
}

if (pathname.startsWith('/admin')) {
  const authResponse = await updateSession(request)
  // ...
  return authResponse
}
```

**ç»“è®º**: âœ… ä¸­é—´ä»¶æ­£ç¡®ä¿æŠ¤äº†ç®¡ç†è·¯ç”±

---

## ğŸ” æƒé™æ£€æŸ¥æµç¨‹

### 1. **è¯·æ±‚æµç¨‹**

```
1. è¯·æ±‚åˆ°è¾¾ â†’ Middleware
   â””â”€> æ£€æŸ¥è·¯å¾„ (/api/admin/* æˆ– /admin/*)
   â””â”€> è°ƒç”¨ updateSession (åˆ·æ–° token)
   
2. API Route Handler
   â””â”€> è°ƒç”¨ requireAdmin/requireRole
   â””â”€> æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
   â””â”€> æŸ¥è¯¢ç”¨æˆ·è§’è‰²
   â””â”€> éªŒè¯è§’è‰²æƒé™
   â””â”€> è¿”å›ç»“æœ
```

---

### 2. **æƒé™æ£€æŸ¥é€»è¾‘**

```typescript
// requireRole å®ç°æµç¨‹
1. getCurrentUser(request) â†’ æ£€æŸ¥ç™»å½•çŠ¶æ€
2. getUserRole(request) â†’ æŸ¥è¯¢ç”¨æˆ·è§’è‰²
3. éªŒè¯è§’è‰²æ˜¯å¦åœ¨å…è®¸åˆ—è¡¨ä¸­
4. è¿”å›ç”¨æˆ·ä¿¡æ¯æˆ– null
```

---

## âœ… ä¸€è‡´æ€§æ£€æŸ¥

### 1. **è§’è‰²å®šä¹‰ä¸€è‡´æ€§** âœ…

| ä½ç½® | è§’è‰²å®šä¹‰ | çŠ¶æ€ |
|------|---------|------|
| `role-helpers.ts` | admin, photographer, retoucher, guest | âœ… |
| `schemas.ts` | admin, photographer, retoucher, guest | âœ… |
| `init-postgresql-db.sql` | admin, photographer, retoucher, guest | âœ… |

**ç»“è®º**: âœ… è§’è‰²å®šä¹‰åœ¨æ‰€æœ‰ä½ç½®ä¸€è‡´

---

### 2. **æƒé™æ£€æŸ¥ä¸€è‡´æ€§** âš ï¸

| API ç±»å‹ | æƒé™æ£€æŸ¥ | çŠ¶æ€ |
|---------|---------|------|
| ç”¨æˆ·ç®¡ç† | `requireAdmin` | âœ… |
| ä¿®å›¾ä»»åŠ¡ | `requireRetoucherOrAdmin` | âœ… |
| ç›¸å†Œç®¡ç† | `getCurrentUser` (ä»…ç™»å½•) | âš ï¸ |
| å…¶ä»–ç®¡ç† | `getCurrentUser` (ä»…ç™»å½•) | âš ï¸ |

**é—®é¢˜**:
- âš ï¸ éƒ¨åˆ†ç®¡ç† API åªæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œä¸æ£€æŸ¥è§’è‰²
- **é£é™©**: éç®¡ç†å‘˜ç”¨æˆ·å¯èƒ½è®¿é—®ç®¡ç†åŠŸèƒ½

---

## ğŸ› å‘ç°çš„é—®é¢˜

### 1. **ç›¸å†Œç®¡ç† API ç¼ºå°‘è§’è‰²æ£€æŸ¥** âš ï¸ **ä¸­ç­‰**

**é—®é¢˜**: 
- `GET /api/admin/albums` åªæ£€æŸ¥ç™»å½•çŠ¶æ€
- `POST /api/admin/albums` å¯èƒ½ç¼ºå°‘æƒé™æ£€æŸ¥

**å½±å“**:
- ä»»ä½•ç™»å½•ç”¨æˆ·éƒ½å¯ä»¥è®¿é—®ç›¸å†Œç®¡ç†åŠŸèƒ½
- å¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯

**ä¿®å¤å»ºè®®**:
```typescript
// ä¿®æ”¹å‰
const user = await getCurrentUser(request)
if (!user) {
  return ApiError.unauthorized('è¯·å…ˆç™»å½•')
}

// ä¿®æ”¹å
const admin = await requireAdmin(request)
if (!admin) {
  return ApiError.forbidden('éœ€è¦ç®¡ç†å‘˜æƒé™')
}
```

---

### 2. **ä¸€è‡´æ€§æ£€æŸ¥ API ç¼ºå°‘è§’è‰²æ£€æŸ¥** âš ï¸ **ä¸­ç­‰**

**é—®é¢˜**: 
- `POST /api/admin/consistency/check` åªæ£€æŸ¥ç™»å½•çŠ¶æ€

**å½±å“**:
- ä»»ä½•ç™»å½•ç”¨æˆ·éƒ½å¯ä»¥æ‰§è¡Œä¸€è‡´æ€§æ£€æŸ¥
- å¯èƒ½å½±å“ç³»ç»Ÿæ€§èƒ½

**ä¿®å¤å»ºè®®**:
```typescript
const admin = await requireAdmin(request)
if (!admin) {
  return ApiError.forbidden('éœ€è¦ç®¡ç†å‘˜æƒé™')
}
```

---

### 3. **å‡çº§æ£€æŸ¥ API éœ€è¦éªŒè¯** âš ï¸ **ä½**

**é—®é¢˜**: 
- `GET /api/admin/upgrade/check` å’Œ `POST /api/admin/upgrade/execute` éœ€è¦æ£€æŸ¥æƒé™

**å½±å“**:
- å¯èƒ½å…è®¸éç®¡ç†å‘˜ç”¨æˆ·æ‰§è¡Œç³»ç»Ÿå‡çº§

**ä¿®å¤å»ºè®®**:
- æ·»åŠ  `requireAdmin` æ£€æŸ¥

---

## âœ… éªŒè¯ç»“æœ

### åŠŸèƒ½å®Œæ•´æ€§ âœ…

1. âœ… è§’è‰²å®šä¹‰å®Œæ•´ï¼ˆ4 ä¸ªè§’è‰²ï¼‰
2. âœ… æƒé™æ£€æŸ¥å‡½æ•°å®Œæ•´
3. âœ… ä¸­é—´ä»¶ä¿æŠ¤å®Œæ•´
4. âš ï¸ éƒ¨åˆ† API è·¯ç”±ç¼ºå°‘è§’è‰²æ£€æŸ¥

### å®‰å…¨æ€§ âœ…

1. âœ… ç”¨æˆ·ç®¡ç† API æœ‰æƒé™ä¿æŠ¤
2. âœ… ä¿®å›¾ä»»åŠ¡ API æœ‰æƒé™ä¿æŠ¤
3. âš ï¸ ç›¸å†Œç®¡ç† API ç¼ºå°‘è§’è‰²æ£€æŸ¥
4. âš ï¸ å…¶ä»–ç®¡ç† API ç¼ºå°‘è§’è‰²æ£€æŸ¥

### ä¸€è‡´æ€§ âš ï¸

1. âœ… è§’è‰²å®šä¹‰ä¸€è‡´
2. âš ï¸ æƒé™æ£€æŸ¥ä¸ä¸€è‡´ï¼ˆéƒ¨åˆ† API åªæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼‰

---

## ğŸ’¡ ä¿®å¤å»ºè®®

### 1. **ç»Ÿä¸€æƒé™æ£€æŸ¥** âœ… **é«˜ä¼˜å…ˆçº§**

**å»ºè®®**: æ‰€æœ‰ `/api/admin/*` è·¯ç”±éƒ½åº”è¯¥ä½¿ç”¨ `requireAdmin` æ£€æŸ¥

**éœ€è¦ä¿®å¤çš„ API**:
- `GET /api/admin/albums`
- `POST /api/admin/albums`
- `POST /api/admin/consistency/check`
- `GET /api/admin/upgrade/check`
- `POST /api/admin/upgrade/execute`
- å…¶ä»–ç®¡ç† API

---

### 2. **æ·»åŠ æƒé™æ£€æŸ¥æ–‡æ¡£** ğŸ’¡ **ä½ä¼˜å…ˆçº§**

**å»ºè®®**: åœ¨ API è·¯ç”±ä¸­æ·»åŠ æƒé™æ£€æŸ¥çš„æ–‡æ¡£æ³¨é‡Š

**ç¤ºä¾‹**:
```typescript
/**
 * @auth éœ€è¦ç®¡ç†å‘˜æƒé™
 */
export async function GET(request: NextRequest) {
  const admin = await requireAdmin(request)
  // ...
}
```

---

## ğŸ“ æ€»ç»“

### âœ… æƒé™ç³»ç»Ÿå®Œæ•´

1. âœ… **è§’è‰²å®šä¹‰**: 4 ä¸ªè§’è‰²å®šä¹‰å®Œæ•´ä¸”ä¸€è‡´
2. âœ… **æƒé™æ£€æŸ¥å‡½æ•°**: æä¾›å®Œæ•´çš„æƒé™æ£€æŸ¥å‡½æ•°
3. âœ… **ä¸­é—´ä»¶ä¿æŠ¤**: æ­£ç¡®ä¿æŠ¤ç®¡ç†è·¯ç”±
4. âœ… **ç”¨æˆ·ç®¡ç† API**: æ‰€æœ‰ API éƒ½æœ‰æƒé™ä¿æŠ¤

### âš ï¸ éœ€è¦æ”¹è¿›

1. âš ï¸ **ç›¸å†Œç®¡ç† API**: ç¼ºå°‘è§’è‰²æ£€æŸ¥ï¼ˆåªæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼‰
2. âš ï¸ **å…¶ä»–ç®¡ç† API**: éƒ¨åˆ† API ç¼ºå°‘è§’è‰²æ£€æŸ¥
3. âš ï¸ **æƒé™æ£€æŸ¥ä¸€è‡´æ€§**: éƒ¨åˆ† API åªæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œä¸æ£€æŸ¥è§’è‰²

### âœ… å®‰å…¨æ€§è‰¯å¥½

- âœ… æ ¸å¿ƒç®¡ç†åŠŸèƒ½ï¼ˆç”¨æˆ·ç®¡ç†ï¼‰æœ‰å®Œæ•´çš„æƒé™ä¿æŠ¤
- âœ… ä¸­é—´ä»¶æ­£ç¡®ä¿æŠ¤ç®¡ç†è·¯ç”±
- âœ… æƒé™æ£€æŸ¥å‡½æ•°å®ç°æ­£ç¡®

---

**æœ€åæ›´æ–°**: 2026-02-06
