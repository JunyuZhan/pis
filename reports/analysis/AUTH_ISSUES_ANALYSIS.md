# ğŸ” PIS è®¤è¯ç³»ç»Ÿé—®é¢˜åˆ†ææŠ¥å‘Š

**åˆ†ææ—¶é—´**: 2026-02-06  
**åˆ†æèŒƒå›´**: ç™»å½•/ç™»å‡ºé€»è¾‘ã€ä¼šè¯ç®¡ç†ã€æ„å¤–ç™»å‡ºé—®é¢˜

---

## ğŸš¨ å‘ç°çš„æ½œåœ¨é—®é¢˜

### 1. **useAuth Hook çš„é”™è¯¯å¤„ç†é—®é¢˜** âš ï¸ **ä¸¥é‡**

**ä½ç½®**: `apps/web/src/hooks/use-auth.ts`

**é—®é¢˜æè¿°**:
```typescript
useEffect(() => {
  const fetchUser = async () => {
    try {
      const res = await fetch('/api/auth/me')
      const data = await res.json()
      setUser(data.user)
    } catch {
      setUser(null)  // âš ï¸ é—®é¢˜ï¼šç½‘ç»œé”™è¯¯æ—¶ä¹Ÿä¼šè®¾ç½® user ä¸º null
    } finally {
      setLoading(false)
    }
  }

  fetchUser()
  const interval = setInterval(fetchUser, 5 * 60 * 1000)  // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
  return () => clearInterval(interval)
}, [])
```

**é—®é¢˜åˆ†æ**:
- æ¯5åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡è®¤è¯çŠ¶æ€
- å¦‚æœ `/api/auth/me` è¯·æ±‚å¤±è´¥ï¼ˆç½‘ç»œé”™è¯¯ã€è¶…æ—¶ã€æœåŠ¡å™¨é”™è¯¯ï¼‰ï¼Œ`catch` å—ä¼šè®¾ç½® `user` ä¸º `null`
- ä½†æ­¤æ—¶ç”¨æˆ·çš„ Cookieï¼ˆJWT tokenï¼‰å¯èƒ½ä»ç„¶æœ‰æ•ˆ
- è¿™ä¼šå¯¼è‡´å‰ç«¯æ˜¾ç¤º"æœªç™»å½•"ï¼Œä½†å®é™… session è¿˜åœ¨ï¼Œé€ æˆçŠ¶æ€ä¸ä¸€è‡´

**å½±å“**:
- ç”¨æˆ·å¯èƒ½çœ‹åˆ°"æœªç™»å½•"çš„ UIï¼Œä½†åˆ·æ–°é¡µé¢ååˆèƒ½æ­£å¸¸è®¿é—®
- ç‚¹å‡»æŸäº›åŠŸèƒ½æ—¶å¯èƒ½è§¦å‘æ„å¤–çš„é‡å®šå‘åˆ°ç™»å½•é¡µ
- ç”¨æˆ·ä½“éªŒå·®ï¼Œæ„Ÿè§‰ç³»ç»Ÿä¸ç¨³å®š

**ä¿®å¤å»ºè®®**:
```typescript
useEffect(() => {
  const fetchUser = async () => {
    try {
      const res = await fetch('/api/auth/me')
      if (!res.ok) {
        // åªæœ‰æ˜ç¡®è¿”å› 401/403 æ—¶æ‰æ¸…é™¤ç”¨æˆ·çŠ¶æ€
        if (res.status === 401 || res.status === 403) {
          setUser(null)
        }
        // å…¶ä»–é”™è¯¯ï¼ˆ500ã€ç½‘ç»œé”™è¯¯ç­‰ï¼‰ä¸æ”¹å˜ç”¨æˆ·çŠ¶æ€
        return
      }
      const data = await res.json()
      setUser(data.user)
    } catch (error) {
      // ç½‘ç»œé”™è¯¯æ—¶ä¸æ”¹å˜ç”¨æˆ·çŠ¶æ€ï¼Œåªè®°å½•æ—¥å¿—
      console.warn('[useAuth] Failed to fetch user, but keeping current state:', error)
      // ä¸è®¾ç½® setUser(null)ï¼Œä¿æŒå½“å‰çŠ¶æ€
    } finally {
      setLoading(false)
    }
  }

  fetchUser()
  const interval = setInterval(fetchUser, 5 * 60 * 1000)
  return () => clearInterval(interval)
}, [])
```

---

### 2. **API Routes ä¸­çš„ Token åˆ·æ–°ä¸ä¸€è‡´** âš ï¸ **ä¸­ç­‰**

**ä½ç½®**: `apps/web/src/lib/auth/jwt-helpers.ts` - `getUserFromRequest`

**é—®é¢˜æè¿°**:
```typescript
// å¦‚æœè®¿é—®ä»¤ç‰Œæ— æ•ˆï¼ˆä¸å­˜åœ¨æˆ–è¿‡æœŸï¼‰ä¸”åˆ·æ–°ä»¤ç‰Œå­˜åœ¨ï¼Œå°è¯•åˆ·æ–°
if (refreshToken) {
  const refreshPayload = await verifyToken(refreshToken)
  if (refreshPayload && refreshPayload.type === 'refresh') {
    // åˆ·æ–°ä»¤ç‰Œæœ‰æ•ˆï¼Œä½†è®¿é—®ä»¤ç‰Œæ— æ•ˆ
    // åœ¨ API Routes ä¸­ï¼Œæˆ‘ä»¬ä¸èƒ½è®¾ç½® cookieï¼Œæ‰€ä»¥è¿”å›ç”¨æˆ·ä¿¡æ¯
    // è°ƒç”¨è€…éœ€è¦ç¡®ä¿ä¸­é—´ä»¶å·²ç»åˆ·æ–°äº† token
    return {
      id: refreshPayload.sub,
      email: refreshPayload.email,
    }
  }
}
```

**é—®é¢˜åˆ†æ**:
- åœ¨ API Routes ä¸­ï¼Œ`getUserFromRequest` æ£€æµ‹åˆ° refresh token æœ‰æ•ˆä½† access token æ— æ•ˆæ—¶ï¼Œä¼šè¿”å›ç”¨æˆ·ä¿¡æ¯
- ä½†**ä¸ä¼šè®¾ç½®æ–°çš„ access token cookie**ï¼ˆå› ä¸º API Routes ä¸èƒ½ç›´æ¥è®¾ç½® cookieï¼‰
- è¿™å¯¼è‡´åç»­è¯·æ±‚ä»ç„¶ä¼šå¤±è´¥ï¼Œç›´åˆ°ä¸­é—´ä»¶åˆ·æ–° token

**å½±å“**:
- API è°ƒç”¨å¯èƒ½é—´æ­‡æ€§å¤±è´¥
- ç”¨æˆ·å¯èƒ½åœ¨æŸäº›æ“ä½œæ—¶è¢«æ„å¤–ç™»å‡º

**ä¿®å¤å»ºè®®**:
- ç¡®ä¿æ‰€æœ‰ API Routes éƒ½é€šè¿‡ä¸­é—´ä»¶å¤„ç†ï¼ˆå·²åœ¨ `/api/admin/*` å®ç°ï¼‰
- æˆ–è€…åœ¨ API Routes ä¸­è¿”å›ç‰¹æ®Šçš„å“åº”å¤´ï¼Œæç¤ºå®¢æˆ·ç«¯åˆ·æ–° token

---

### 3. **å¤šä¸ªä¸­é—´ä»¶å®ç°** âš ï¸ **ä¸­ç­‰**

**å‘ç°çš„æ–‡ä»¶**:
- `apps/web/src/lib/auth/middleware.ts` - è‡ªå®šä¹‰è®¤è¯ä¸­é—´ä»¶ï¼ˆæ­£åœ¨ä½¿ç”¨ï¼‰
- `apps/web/src/lib/supabase/middleware.ts` - Supabase ä¸­é—´ä»¶ï¼ˆå¯èƒ½æœªä½¿ç”¨ï¼‰
- `apps/web/src/lib/auth/compat.ts` - å…¼å®¹å±‚ä¸­é—´ä»¶ï¼ˆå¯èƒ½æœªä½¿ç”¨ï¼‰

**é—®é¢˜åˆ†æ**:
- å­˜åœ¨å¤šä¸ªä¸­é—´ä»¶å®ç°ï¼Œå¯èƒ½å¯¼è‡´æ··æ·†
- å¦‚æœæŸä¸ªåœ°æ–¹é”™è¯¯åœ°å¯¼å…¥äº†é”™è¯¯çš„ä¸­é—´ä»¶ï¼Œä¼šå¯¼è‡´è®¤è¯é€»è¾‘ä¸ä¸€è‡´

**ä¿®å¤å»ºè®®**:
- ç¡®è®¤å½“å‰ä½¿ç”¨çš„ä¸­é—´ä»¶ï¼ˆåº”è¯¥æ˜¯ `lib/auth/middleware.ts`ï¼‰
- åˆ é™¤æˆ–æ ‡è®°æœªä½¿ç”¨çš„ä¸­é—´ä»¶å®ç°
- åœ¨ä»£ç ä¸­æ·»åŠ æ³¨é‡Šè¯´æ˜ä½¿ç”¨å“ªä¸ªä¸­é—´ä»¶

---

### 4. **ä¸­é—´ä»¶åªä¿æŠ¤ç‰¹å®šè·¯å¾„** âš ï¸ **è½»å¾®**

**ä½ç½®**: `apps/web/src/middleware.ts`

**é—®é¢˜æè¿°**:
```typescript
// Handle custom auth for admin API routes (refresh session for API calls)
if (pathname.startsWith('/api/admin')) {
  return await updateSession(request)
}

// Handle custom auth for admin routes first (takes priority over locale)
if (pathname.startsWith('/admin')) {
  const authResponse = await updateSession(request)
  // ...
  return authResponse
}
```

**é—®é¢˜åˆ†æ**:
- ä¸­é—´ä»¶åªä¿æŠ¤ `/admin/*` å’Œ `/api/admin/*` è·¯å¾„
- å…¶ä»– API è·¯ç”±ï¼ˆå¦‚ `/api/auth/*`ï¼‰ä¸ç»è¿‡ä¸­é—´ä»¶çš„ token åˆ·æ–°é€»è¾‘
- è¿™å¯èƒ½å¯¼è‡´æŸäº› API è°ƒç”¨æ—¶ token æœªåˆ·æ–°

**å½±å“**:
- å¦‚æœç”¨æˆ·åœ¨é admin é¡µé¢è°ƒç”¨ APIï¼Œtoken å¯èƒ½æœªåˆ·æ–°
- ä½†å½±å“è¾ƒå°ï¼Œå› ä¸º `/api/auth/*` è·¯ç”±é€šå¸¸ä¸éœ€è¦è®¤è¯

**ä¿®å¤å»ºè®®**:
- å½“å‰è®¾è®¡æ˜¯åˆç†çš„ï¼Œå› ä¸ºåªæœ‰ admin ç›¸å…³è·¯ç”±éœ€è¦è®¤è¯
- å¦‚æœæœªæ¥æœ‰å…¶ä»–éœ€è¦è®¤è¯çš„è·¯ç”±ï¼Œéœ€è¦æ·»åŠ åˆ°ä¸­é—´ä»¶

---

### 5. **Layout ç»„ä»¶ä¸­çš„è®¤è¯æ£€æŸ¥** âœ… **æ­£å¸¸ä½†å¯èƒ½æœ‰é—®é¢˜**

**ä½ç½®**: `apps/web/src/app/admin/(dashboard)/layout.tsx`

**é—®é¢˜æè¿°**:
```typescript
export default async function AdminLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const user = await getCurrentUser()

  if (!user) {
    redirect('/admin/login')
  }
  // ...
}
```

**é—®é¢˜åˆ†æ**:
- Layout ç»„ä»¶åœ¨æœåŠ¡ç«¯æ£€æŸ¥è®¤è¯çŠ¶æ€
- å¦‚æœ `getCurrentUser()` è¿”å› `null`ï¼Œä¼šé‡å®šå‘åˆ°ç™»å½•é¡µ
- ä½†å¦‚æœ token åˆ·æ–°å¤±è´¥ï¼ˆç½‘ç»œé—®é¢˜ï¼‰ï¼Œå¯èƒ½å¯¼è‡´è¯¯åˆ¤

**å½±å“**:
- æœåŠ¡ç«¯æ¸²æŸ“æ—¶å¦‚æœ token éªŒè¯å¤±è´¥ï¼Œä¼šç«‹å³é‡å®šå‘
- ä½†ä¸­é—´ä»¶åº”è¯¥å·²ç»å¤„ç†äº† token åˆ·æ–°ï¼Œæ‰€ä»¥è¿™ä¸ªé—®é¢˜åº”è¯¥ä¸å¸¸è§

**ä¿®å¤å»ºè®®**:
- å½“å‰å®ç°æ˜¯åˆç†çš„
- ç¡®ä¿ä¸­é—´ä»¶æ­£ç¡®åˆ·æ–° token å³å¯

---

## ğŸ”§ ä¿®å¤ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¿®å¤ï¼‰

1. **ä¿®å¤ useAuth Hook çš„é”™è¯¯å¤„ç†**
   - é—®é¢˜ï¼šç½‘ç»œé”™è¯¯æ—¶é”™è¯¯åœ°æ¸…é™¤ç”¨æˆ·çŠ¶æ€
   - å½±å“ï¼šç”¨æˆ·ä½“éªŒå·®ï¼Œæ„Ÿè§‰ç³»ç»Ÿä¸ç¨³å®š
   - ä¿®å¤éš¾åº¦ï¼šä½

### ä¸­ä¼˜å…ˆçº§ï¼ˆå°½å¿«ä¿®å¤ï¼‰

2. **æ¸…ç†æœªä½¿ç”¨çš„ä¸­é—´ä»¶å®ç°**
   - é—®é¢˜ï¼šä»£ç æ··æ·†ï¼Œå¯èƒ½å¯¼è‡´é”™è¯¯å¯¼å…¥
   - å½±å“ï¼šä»£ç ç»´æŠ¤æ€§å·®
   - ä¿®å¤éš¾åº¦ï¼šä½

3. **æ”¹è¿› API Routes ä¸­çš„ token åˆ·æ–°**
   - é—®é¢˜ï¼šAPI Routes ä¸­ token åˆ·æ–°ä¸ä¸€è‡´
   - å½±å“ï¼šAPI è°ƒç”¨å¯èƒ½é—´æ­‡æ€§å¤±è´¥
   - ä¿®å¤éš¾åº¦ï¼šä¸­

### ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰

4. **æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—**
   - å¸®åŠ©è°ƒè¯•è®¤è¯é—®é¢˜
   - ä¿®å¤éš¾åº¦ï¼šä½

---

## ğŸ“‹ æµ‹è¯•å»ºè®®

### 1. ç½‘ç»œé”™è¯¯åœºæ™¯æµ‹è¯•

```bash
# æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯
# 1. ç™»å½•ç³»ç»Ÿ
# 2. æ–­å¼€ç½‘ç»œè¿æ¥
# 3. ç­‰å¾… 5 åˆ†é’Ÿï¼ˆuseAuth æ£€æŸ¥é—´éš”ï¼‰
# 4. æ£€æŸ¥æ˜¯å¦è¢«æ„å¤–ç™»å‡º
# 5. æ¢å¤ç½‘ç»œè¿æ¥
# 6. æ£€æŸ¥æ˜¯å¦èƒ½æ­£å¸¸è®¿é—®
```

### 2. Token è¿‡æœŸåœºæ™¯æµ‹è¯•

```bash
# æ¨¡æ‹Ÿ token è¿‡æœŸ
# 1. ç™»å½•ç³»ç»Ÿ
# 2. æ‰‹åŠ¨ä¿®æ”¹ access token cookieï¼Œä½¿å…¶è¿‡æœŸ
# 3. è®¿é—® admin é¡µé¢
# 4. æ£€æŸ¥æ˜¯å¦è‡ªåŠ¨åˆ·æ–° token
# 5. æ£€æŸ¥æ˜¯å¦èƒ½æ­£å¸¸è®¿é—®
```

### 3. å¹¶å‘è¯·æ±‚æµ‹è¯•

```bash
# æµ‹è¯•å¤šä¸ªå¹¶å‘è¯·æ±‚æ—¶çš„è®¤è¯çŠ¶æ€
# 1. ç™»å½•ç³»ç»Ÿ
# 2. åŒæ—¶å‘é€å¤šä¸ª API è¯·æ±‚
# 3. æ£€æŸ¥æ˜¯å¦æ‰€æœ‰è¯·æ±‚éƒ½èƒ½æ­£å¸¸å¤„ç†
# 4. æ£€æŸ¥ token æ˜¯å¦æ­£ç¡®åˆ·æ–°
```

---

## âœ… ä¿®å¤åçš„é¢„æœŸæ•ˆæœ

1. **ç½‘ç»œé”™è¯¯ä¸ä¼šå¯¼è‡´æ„å¤–ç™»å‡º**
   - ç”¨æˆ·åœ¨ç½‘ç»œä¸ç¨³å®šæ—¶ä»èƒ½æ­£å¸¸ä½¿ç”¨ç³»ç»Ÿ
   - åªæœ‰æ˜ç¡®è®¤è¯å¤±è´¥æ—¶æ‰æ¸…é™¤ç”¨æˆ·çŠ¶æ€

2. **Token åˆ·æ–°æ›´åŠ å¯é **
   - API è°ƒç”¨æ—¶ token èƒ½æ­£ç¡®åˆ·æ–°
   - å‡å°‘è®¤è¯ç›¸å…³çš„é”™è¯¯

3. **ä»£ç æ›´æ¸…æ™°**
   - åˆ é™¤æœªä½¿ç”¨çš„ä¸­é—´ä»¶å®ç°
   - å‡å°‘ä»£ç æ··æ·†

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `apps/web/src/hooks/use-auth.ts` - useAuth Hook
- `apps/web/src/lib/auth/jwt-helpers.ts` - JWT è¾…åŠ©å‡½æ•°
- `apps/web/src/lib/auth/middleware.ts` - è®¤è¯ä¸­é—´ä»¶
- `apps/web/src/middleware.ts` - Next.js ä¸­é—´ä»¶
- `apps/web/src/app/admin/(dashboard)/layout.tsx` - Admin Layout

---

**æœ€åæ›´æ–°**: 2026-02-06
